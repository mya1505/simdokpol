<script>
$(document).ready(function () {
    // --- HELPER UI ---
    $("body").on("input", ".auto-uppercase", function () { $(this).val($(this).val().toUpperCase()); });
    $("body").on("input", ".auto-titlecase", function () { 
        $(this).val($(this).val().toLowerCase().replace(/\b\w/g, s => s.toUpperCase())); 
    });

    // --- TOGGLE DB DISPLAY ---
    function toggleDBSettings(dialect) {
        if (dialect === 'sqlite') {
            $('#sqlite-settings').show();
            $('#server-db-settings').hide();
        } else {
            $('#sqlite-settings').hide();
            $('#server-db-settings').show();
            
            if (dialect === 'mysql') {
                $('#db_port').attr('placeholder', '3306');
                $('#settings-pg-ssl-group').hide();
            } else {
                $('#db_port').attr('placeholder', '5432');
                $('#settings-pg-ssl-group').show();
            }
        }
    }
    
    $('#db_dialect').change(function() { toggleDBSettings($(this).val()); });

    // --- LOAD SETTINGS ---
    function loadSettings() {
        $.ajax({
            url: "/api/settings",
            method: "GET",
            success: function (s) {
                // Fill Form
                $("#kop_baris_1").val(s.kop_baris_1);
                $("#kop_baris_2").val(s.kop_baris_2);
                $("#kop_baris_3").val(s.kop_baris_3);
                $("#nama_kantor").val(s.nama_kantor);
                $("#tempat_surat").val(s.tempat_surat);
                $("#format_nomor_surat").val(s.format_nomor_surat);
                $("#backup_path").val(s.backup_path);

                $("#db_dialect").val(s.db_dialect || 'sqlite');
                $("#db_host").val(s.db_host);
                $("#db_port").val(s.db_port);
                $("#db_name").val(s.db_name);
                $("#db_user").val(s.db_user);
                $("#db_dsn").val(s.db_dsn);
                $("#db_sslmode").val(s.db_sslmode || 'disable');

                toggleDBSettings(s.db_dialect || 'sqlite');
            }
        });
    }
    loadSettings();

    // --- SAVE CONFIG ---
    $('#settings-form').submit(function(e) {
        e.preventDefault();
        let btn = $('#submit-btn');
        btn.prop('disabled', true).html('Menyimpan...');

        let data = {
            db_dialect: $("#db_dialect").val(),
            db_host: $("#db_host").val(),
            db_port: $("#db_port").val(),
            db_name: $("#db_name").val(),
            db_user: $("#db_user").val(),
            db_pass: $("#db_pass").val(),
            db_sslmode: $("#db_sslmode").val(),
            
            kop_baris_1: $("#kop_baris_1").val(),
            kop_baris_2: $("#kop_baris_2").val(),
            kop_baris_3: $("#kop_baris_3").val(),
            nama_kantor: $("#nama_kantor").val(),
            tempat_surat: $("#tempat_surat").val(),
            format_nomor_surat: $("#format_nomor_surat").val(),
            backup_path: $("#backup_path").val()
        };

        $.ajax({
            url: "/api/settings",
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function() {
                Swal.fire("Sukses", "Pengaturan disimpan. Restart aplikasi untuk efek DB.", "success");
                $("#db_pass").val("");
            },
            error: function() { Swal.fire("Gagal", "Tidak dapat menyimpan.", "error"); },
            complete: function() { btn.prop('disabled', false).html('<i class="fas fa-save mr-2"></i>Simpan Perubahan'); }
        });
    });

    // --- TEST DB ---
    $('#test-db-btn').click(function() {
        let btn = $(this);
        btn.prop('disabled', true).text('Menguji...');
        
        let payload = {
            db_dialect: $("#db_dialect").val(),
            db_host: $("#db_host").val(),
            db_port: $("#db_port").val(),
            db_name: $("#db_name").val(),
            db_user: $("#db_user").val(),
            db_pass: $("#db_pass").val(),
            db_sslmode: $("#db_sslmode").val()
        };

        $.ajax({
            url: "/api/db/test", method: "POST",
            contentType: "application/json", data: JSON.stringify(payload),
            success: function() { Swal.fire("Sukses", "Koneksi OK!", "success"); },
            error: function() { Swal.fire("Gagal", "Koneksi ditolak.", "error"); },
            complete: function() { btn.prop('disabled', false).text('Tes Koneksi'); }
        });
    });

    // --- MIGRATION LOGIC ---
    $('#mig_dialect').change(function() {
        if($(this).val() === 'postgres') {
            $('#mig_port').val('5432');
            $('#mig-ssl-wrap').show();
        } else {
            $('#mig_port').val('3306');
            $('#mig-ssl-wrap').hide();
        }
    });

    $('#migration-form').submit(function(e) {
        e.preventDefault();
        
        let target = {
            db_dialect: $('#mig_dialect').val(),
            db_host: $('#mig_host').val(),
            db_port: $('#mig_port').val(),
            db_name: $('#mig_name').val(),
            db_user: $('#mig_user').val(),
            db_pass: $('#mig_pass').val(),
            db_sslmode: $('#mig_sslmode').val()
        };

        Swal.fire({
            title: 'Mulai Migrasi?',
            text: "Data akan disalin ke database target. Target harus kosong.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Migrasi',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return fetch("/api/settings/migrate", {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(target)
                }).then(async r => {
                    if(!r.ok) throw new Error((await r.json()).error);
                    return r.json();
                }).catch(err => Swal.showValidationMessage(err));
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire("Sukses", "Migrasi berhasil! Silakan ganti config DB utama.", "success");
            }
        });
    });

    // Backup & Restore Logic (Sama seperti sebelumnya)
    $("#backup-btn").click(function() {
        window.location.href = "/api/backups"; // Simplifikasi download
    });

    $("#restore-form").submit(function(e) {
        e.preventDefault();
        let fd = new FormData(this);
        $.ajax({
            url: "/api/restore", method: "POST",
            data: fd, processData: false, contentType: false,
            success: function() { Swal.fire("Sukses", "Restore berhasil.", "success").then(()=>location.reload()); },
            error: function() { Swal.fire("Gagal", "File rusak/salah format.", "error"); }
        });
    });
});
</script>