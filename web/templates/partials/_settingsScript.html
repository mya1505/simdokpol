<script>
$(document).ready(function () {
    // --- HELPER UI ---
    $("body").on("input", ".auto-uppercase", function () { $(this).val($(this).val().toUpperCase()); });
    $("body").on("input", ".auto-titlecase", function () { $(this).val(toTitleCase($(this).val())); });
    function toTitleCase(str) { return str.replace(/\w\S*/g, function(txt) { return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); }); }

    // --- LOAD SETTINGS & CEK LICENSE ---
    function loadSettings() {
        $.ajax({
            url: "/api/settings", method: "GET",
            success: function (s) {
                if (!s) return;

                // UMUM
                $("#kop_baris_1").val(s.kop_baris_1); $("#kop_baris_2").val(s.kop_baris_2); $("#kop_baris_3").val(s.kop_baris_3);
                $("#nama_kantor").val(s.nama_kantor); $("#tempat_surat").val(s.tempat_surat);
                $("#format_nomor_surat").val(s.format_nomor_surat); $("#nomor_surat_terakhir").val(s.nomor_surat_terakhir);
                $("#zona_waktu").val(s.zona_waktu); $("#archive_duration_days").val(s.archive_duration_days);
                $("#session_timeout").val(s.session_timeout); $("#idle_timeout").val(s.idle_timeout);
                $("#enable_https").prop('checked', s.enable_https);

                // DATABASE
                $("#db_dialect").val(s.db_dialect || 'sqlite');
                $("#db_dsn").val(s.db_dsn);
                $("#db_host").val(s.db_host); $("#db_port").val(s.db_port);
                $("#db_name").val(s.db_name); $("#db_user").val(s.db_user);
                $("#db_sslmode").val(s.db_sslmode || 'disable');

                // BACKUP
                $("#backup_path").val(s.backup_path);

                // --- LOGIKA LISENSI PRO ---
                const isPro = (s.license_status === 'VALID');
                
                // Reset State
                $('#enable_https').prop('disabled', false);
                $('#https-pro-badge').hide();
                $('#db_dialect option').prop('disabled', false).each(function() { $(this).text($(this).text().replace(' (Fitur Pro ðŸ”’)', '')); });
                $('#migration-form input, #migration-form select, #migration-form button').prop('disabled', false);
                $('#pro-migration-alert').remove();
                $('#btn-migrate').html('<i class="fas fa-rocket mr-2"></i> Mulai Migrasi Data').removeClass('btn-secondary').addClass('btn-warning');

                if (!isPro) {
                    // KUNCI FITUR PRO
                    $('#enable_https').prop('disabled', true);
                    $('#https-pro-badge').show();
                    
                    if (s.db_dialect === 'sqlite') {
                        $('#db_dialect option[value="mysql"]').prop('disabled', true).text('MySQL (Fitur Pro ðŸ”’)');
                        $('#db_dialect option[value="postgres"]').prop('disabled', true).text('PostgreSQL (Fitur Pro ðŸ”’)');
                    }
                    
                    $('#migration-form input, #migration-form select').prop('disabled', true);
                    $('#btn-migrate').prop('disabled', true).removeClass('btn-warning').addClass('btn-secondary').html('<i class="fas fa-lock mr-2"></i> Fitur Terkunci (Pro Only)');
                    
                    if($('#pro-migration-alert').length === 0) {
                        $('#migration-panel').prepend(`
                            <div id="pro-migration-alert" class="alert alert-danger border-left-danger shadow-sm">
                                <div class="d-flex align-items-center">
                                    <div class="mr-3"><i class="fas fa-lock fa-2x"></i></div>
                                    <div>
                                        <h5 class="alert-heading font-weight-bold mb-1">Fitur Pro Terkunci</h5>
                                        <p class="mb-0">Fitur HTTPS, Database Server, dan Migrasi hanya tersedia di versi Pro. Silakan aktivasi lisensi.</p>
                                    </div>
                                </div>
                            </div>
                        `);
                    }
                }

                toggleDBSettings(s.db_dialect || 'sqlite');
            },
            error: function() { Swal.fire("Error", "Gagal memuat data.", "error"); }
        });
    }
    loadSettings();

    // --- TOGGLE UI DATABASE ---
    function toggleDBSettings(dialect) {
        if (dialect === 'sqlite') {
            $('#sqlite-settings').slideDown(); $('#server-db-settings').slideUp();
            $('#backup-btn, #restore-btn, #restore-file').prop('disabled', false);
        } else {
            $('#sqlite-settings').slideUp(); $('#server-db-settings').slideDown();
            $('#backup-btn, #restore-btn, #restore-file').prop('disabled', true);
            $('#settings-pg-ssl-group').slideDown();
            
            if (dialect === 'mysql') $('#db_port').attr('placeholder', '3306');
            else if (dialect === 'postgres') $('#db_port').attr('placeholder', '5432');
        }
    }
    $('#db_dialect').change(function() { toggleDBSettings($(this).val()); });

    // --- HELPER UNTUK RESTART OTOMATIS ---
    function handleRestartSequence(isRequired) {
        if (isRequired) {
            let timerInterval;
            Swal.fire({
                title: 'Sistem Dimulai Ulang', 
                html: 'Konfigurasi tersimpan. Restart otomatis...<br>Mohon tunggu...', 
                icon: 'success',
                timer: 5000, 
                timerProgressBar: true, 
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading(), 
                willClose: () => clearInterval(timerInterval)
            }).then(() => window.location.reload());
        } else {
            Swal.fire("Sukses", "Pengaturan disimpan.", "success");
        }
    }

    // --- SUBMIT CONFIG (GENERAL) DENGAN LOGIC HTTPS ---
    $('#general-form').submit(function(e) {
        e.preventDefault();
        
        let data = {
            kop_baris_1: $("#kop_baris_1").val(), kop_baris_2: $("#kop_baris_2").val(), kop_baris_3: $("#kop_baris_3").val(),
            nama_kantor: $("#nama_kantor").val(), tempat_surat: $("#tempat_surat").val(),
            format_nomor_surat: $("#format_nomor_surat").val(), nomor_surat_terakhir: $("#nomor_surat_terakhir").val(),
            zona_waktu: $("#zona_waktu").val(), archive_duration_days: $("#archive_duration_days").val(),
            session_timeout: $("#session_timeout").val(), idle_timeout: $("#idle_timeout").val(),
            enable_https: $("#enable_https").is(":checked") ? "true" : "false"
        };

        Swal.fire({title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        $.ajax({
            url: "/api/settings", method: "PUT", contentType: "application/json", data: JSON.stringify(data),
            success: function(response) {
                // --- LOGIC BARU: TAWARKAN INSTALL SERTIFIKAT ---
                if (response.check_https_cert) {
                    Swal.fire({
                        title: 'Install Sertifikat Keamanan?',
                        text: "Agar browser tidak menampilkan layar merah 'Not Secure', sertifikat perlu diinstal ke Windows. Lakukan sekarang?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Ya, Install Otomatis',
                        cancelButtonText: 'Tidak, Nanti Saja',
                        confirmButtonColor: '#1cc88a'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Panggil API Install
                            Swal.fire({
                                title: 'Meminta Izin Administrator...',
                                text: 'Silakan klik "Yes" pada popup Windows yang muncul.',
                                icon: 'info',
                                showConfirmButton: false,
                                allowOutsideClick: false
                            });
                            
                            $.ajax({
                                url: "/api/settings/install-cert",
                                method: "POST",
                                success: function() {
                                    handleRestartSequence(response.restart_required);
                                },
                                error: function() {
                                    Swal.fire("Gagal", "Instalasi dibatalkan atau gagal.", "error")
                                        .then(() => handleRestartSequence(response.restart_required));
                                }
                            });
                        } else {
                            // User pilih No, langsung restart
                            handleRestartSequence(response.restart_required);
                        }
                    });
                } else {
                    // Tidak aktifkan HTTPS, langsung proses restart biasa
                    handleRestartSequence(response.restart_required);
                }
            },
            error: function(xhr) { Swal.fire("Gagal", "Error saat menyimpan.", "error"); }
        });
    });

    $('#database-form').submit(function(e) {
        e.preventDefault();
        let data = {
            db_dialect: $("#db_dialect").val(), db_host: $("#db_host").val(), db_port: $("#db_port").val(),
            db_name: $("#db_name").val(), db_user: $("#db_user").val(), db_pass: $("#db_pass").val(),
            db_sslmode: $("#db_sslmode").val()
        };
        if(data.db_pass === "") delete data.db_pass;
        
        // Database config tidak butuh cek HTTPS cert
        Swal.fire({title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        $.ajax({
            url: "/api/settings", method: "PUT", contentType: "application/json", data: JSON.stringify(data),
            success: function(response) { handleRestartSequence(response.restart_required); },
            error: function(xhr) { Swal.fire("Gagal", "Error saat menyimpan DB.", "error"); }
        });
    });

    // --- TEST DB & MIGRASI (SAMA SEPERTI SEBELUMNYA) ---
    $('#test-db-btn').click(function() {
        let btn = $(this); btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Test...');
        let payload = {
            db_dialect: $("#db_dialect").val(), db_host: $("#db_host").val(), db_port: $("#db_port").val(),
            db_name: $("#db_name").val(), db_user: $("#db_user").val(), db_pass: $("#db_pass").val(), db_sslmode: $("#db_sslmode").val()
        };
        $.ajax({ url: "/api/db/test", method: "POST", contentType: "application/json", data: JSON.stringify(payload),
            success: function() { Swal.fire("Sukses", "Koneksi OK!", "success"); },
            error: function(xhr) { Swal.fire("Gagal", xhr.responseJSON?.error || "Koneksi Ditolak", "error"); },
            complete: function() { btn.prop('disabled', false).html('<i class="fas fa-plug mr-1"></i> Tes Koneksi Server'); }
        });
    });

    $('#mig_dialect').change(function() {
        if($(this).val() === 'postgres') { $('#mig_port').val('5432'); $('#mig-ssl-wrap').show(); }
        else { $('#mig_port').val('3306'); $('#mig-ssl-wrap').hide(); }
    });

    $('#migration-form').submit(function(e) {
        e.preventDefault();
        let target = {
            db_dialect: $('#mig_dialect').val(), db_host: $('#mig_host').val(), db_port: $('#mig_port').val(),
            db_name: $('#mig_name').val(), db_user: $('#mig_user').val(), db_pass: $('#mig_pass').val(), db_sslmode: $('#mig_sslmode').val()
        };
        Swal.fire({
            title: 'Mulai Migrasi?', text: "Pastikan target DB kosong.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Gas!',
            preConfirm: () => startMigrationStream(target)
        });
    });

    async function startMigrationStream(targetConfig) {
        $('#migration-panel').slideUp(); $('#migration-progress-area').slideDown();
        const logBox = $('#mig-log'); const pBar = $('#mig-progress-bar'); const stat = $('#mig-status-text');
        logBox.text("");
        
        try {
            const res = await fetch("/api/settings/migrate", {
                method: "POST", headers: {'Content-Type': 'application/json'}, body: JSON.stringify(targetConfig)
            });
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                buffer += decoder.decode(value, {stream:true});
                const lines = buffer.split('\n\n');
                buffer = lines.pop();
                
                for (const line of lines) {
                    if(line.startsWith('event:')) {
                        const type = line.split('\n')[0].replace('event:', '').trim();
                        const data = JSON.parse(line.split('\n')[1].replace('data:', '').trim());
                        
                        if(type === 'progress') {
                            pBar.css('width', data.percent+'%').text(data.percent+'%');
                            stat.text(data.message);
                            logBox.append(`[${data.percent}%] ${data.message}\n`);
                            logBox.scrollTop(logBox[0].scrollHeight);
                        } else if (type === 'complete') {
                            pBar.removeClass('bg-warning').addClass('bg-success').text('100%');
                            Swal.fire("Selesai!", "Migrasi Berhasil.", "success");
                        } else if (type === 'error') {
                            throw new Error(data.message);
                        }
                    }
                }
            }
        } catch(e) {
            pBar.removeClass('bg-warning').addClass('bg-danger');
            stat.text("Error!");
            logBox.append(`\n[ERROR] ${e.message}\n`);
            Swal.fire("Gagal", e.message, "error");
            setTimeout(() => $('#migration-panel').slideDown(), 3000);
        }
    }
});
</script>