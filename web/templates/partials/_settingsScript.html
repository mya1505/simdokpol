<script>
$(document).ready(function () {
    // --- HELPER UI (Auto Format Input) ---
    $("body").on("input", ".auto-uppercase", function () {
        $(this).val($(this).val().toUpperCase());
    });
    $("body").on("input", ".auto-titlecase", function () {
        $(this).val(toTitleCase($(this).val()));
    });
    
    function toTitleCase(str) {
        return str.replace(/\w\S*/g, function(txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
    }

    // --- LOAD SETTINGS AWAL ---
    function loadSettings() {
        $.ajax({
            url: "/api/settings",
            method: "GET",
            success: function (s) {
                if (!s) return;

                // 1. TAB UMUM
                $("#kop_baris_1").val(s.kop_baris_1);
                $("#kop_baris_2").val(s.kop_baris_2);
                $("#kop_baris_3").val(s.kop_baris_3);
                $("#nama_kantor").val(s.nama_kantor);
                $("#tempat_surat").val(s.tempat_surat);
                $("#format_nomor_surat").val(s.format_nomor_surat);
                $("#nomor_surat_terakhir").val(s.nomor_surat_terakhir);
                $("#zona_waktu").val(s.zona_waktu);
                $("#archive_duration_days").val(s.archive_duration_days);
                
                // Timeout & HTTPS
                $("#session_timeout").val(s.session_timeout || 480);
                $("#idle_timeout").val(s.idle_timeout || 15);
                $("#enable_https").prop('checked', s.enable_https);

                // 2. TAB DATABASE
                $("#db_dialect").val(s.db_dialect || 'sqlite');
                $("#db_dsn").val(s.db_dsn);
                $("#db_host").val(s.db_host);
                $("#db_port").val(s.db_port);
                $("#db_name").val(s.db_name);
                $("#db_user").val(s.db_user);
                $("#db_sslmode").val(s.db_sslmode || 'disable');

                // 3. TAB BACKUP
                $("#backup_path").val(s.backup_path);

                // Cek Lisensi untuk UI Database
                const isPro = (s.license_status === 'VALID');
                if (isPro) {
                    $('#db-pro-badge').show();
                    $('#db-free-alert').hide();
                } else {
                    $('#db-pro-badge').hide();
                    if (s.db_dialect === 'sqlite') {
                        $('#db-free-alert').show();
                        $('#db_dialect option[value="mysql"]').prop('disabled', true).text('MySQL (Fitur Pro ðŸ”’)');
                        $('#db_dialect option[value="postgres"]').prop('disabled', true).text('PostgreSQL (Fitur Pro ðŸ”’)');
                    }
                }

                // Sesuaikan tampilan form DB
                toggleDBSettings(s.db_dialect || 'sqlite');
            },
            error: function () {
                Swal.fire("Error", "Gagal memuat data pengaturan.", "error");
            }
        });
    }
    
    // Panggil saat halaman siap
    loadSettings();

    // --- TOGGLE TAMPILAN DB ---
    function toggleDBSettings(dialect) {
        if (dialect === 'sqlite') {
            $('#sqlite-settings').slideDown();
            $('#server-db-settings').slideUp();
            // Enable tombol backup/restore hanya untuk SQLite
            $('#backup-btn, #restore-btn, #restore-file').prop('disabled', false);
        } else {
            $('#sqlite-settings').slideUp();
            $('#server-db-settings').slideDown();
            // Disable tombol backup/restore untuk Server DB
            $('#backup-btn, #restore-btn, #restore-file').prop('disabled', true);
            
            // Atur Port Default & SSL Mode
            // FIX: TAMPILKAN SSL JUGA UNTUK MYSQL
            $('#settings-pg-ssl-group').slideDown();
            
            if (dialect === 'mysql') {
                $('#db_port').attr('placeholder', '3306');
            } else if (dialect === 'postgres') {
                $('#db_port').attr('placeholder', '5432');
            }
        }
    }
    
    $('#db_dialect').on('change', function() {
        toggleDBSettings($(this).val());
    });

    // --- FUNGSI UTAMA: SIMPAN DENGAN AUTO-RESTART ---
    function submitPartialConfig(data, customSuccessMsg) {
        // Tampilkan loading blocker
        Swal.fire({
            title: 'Menyimpan...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        $.ajax({
            url: "/api/settings",
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(response) {
                // CEK APAKAH BACKEND MINTA RESTART?
                if (response.restart_required) {
                    let timerInterval;
                    Swal.fire({
                        title: 'Sistem Dimulai Ulang',
                        html: 'Konfigurasi tersimpan. Aplikasi sedang <b>restart otomatis</b> untuk menerapkan perubahan (Database/HTTPS/Port).<br>Mohon tunggu...',
                        icon: 'info',
                        timer: 5000, // Estimasi waktu restart 5 detik
                        timerProgressBar: true,
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        willClose: () => {
                            clearInterval(timerInterval);
                        }
                    }).then((result) => {
                        // Reload halaman setelah timer habis
                        window.location.reload();
                    });
                } else {
                    // Jika update ringan (misal nama kantor), cukup notifikasi sukses
                    Swal.fire("Sukses", customSuccessMsg || "Pengaturan berhasil disimpan.", "success");
                }
            },
            error: function(xhr) { 
                const msg = xhr.responseJSON ? xhr.responseJSON.error : "Terjadi kesalahan saat menyimpan.";
                Swal.fire("Gagal", msg, "error"); 
            }
        });
    }

    // --- SUBMIT TAB UMUM ---
    $('#general-form').submit(function(e) {
        e.preventDefault();
        const isHttps = $("#enable_https").is(":checked");
        
        submitPartialConfig({
            kop_baris_1: $("#kop_baris_1").val(),
            kop_baris_2: $("#kop_baris_2").val(),
            kop_baris_3: $("#kop_baris_3").val(),
            nama_kantor: $("#nama_kantor").val(),
            tempat_surat: $("#tempat_surat").val(),
            format_nomor_surat: $("#format_nomor_surat").val(),
            nomor_surat_terakhir: $("#nomor_surat_terakhir").val(),
            zona_waktu: $("#zona_waktu").val(),
            archive_duration_days: $("#archive_duration_days").val(),
            
            // Fitur Timeout Baru
            session_timeout: $("#session_timeout").val(),
            idle_timeout: $("#idle_timeout").val(),
            
            // Fitur HTTPS Baru (Kirim sebagai string)
            enable_https: isHttps ? "true" : "false"

        }, "Pengaturan Umum & Keamanan berhasil disimpan.");
    });

    // --- SUBMIT TAB DATABASE ---
    $('#database-form').submit(function(e) {
        e.preventDefault();
        let data = {
            db_dialect: $("#db_dialect").val(),
            db_host: $("#db_host").val(),
            db_port: $("#db_port").val(),
            db_name: $("#db_name").val(),
            db_user: $("#db_user").val(),
            db_pass: $("#db_pass").val(),
            db_sslmode: $("#db_sslmode").val()
        };
        // Jangan kirim password kosong (biar gak overwrite password lama)
        if(data.db_pass === "") delete data.db_pass;

        submitPartialConfig(data);
    });

    // --- TOMBOL TEST KONEKSI ---
    $('#test-db-btn').click(function() {
        let btn = $(this); 
        let originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Menguji...');
        
        let payload = {
            db_dialect: $("#db_dialect").val(),
            db_host: $("#db_host").val(),
            db_port: $("#db_port").val(),
            db_name: $("#db_name").val(),
            db_user: $("#db_user").val(),
            db_pass: $("#db_pass").val(),
            db_sslmode: $("#db_sslmode").val()
        };

        $.ajax({
            url: "/api/db/test",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function() { Swal.fire("Sukses", "Koneksi Database Berhasil!", "success"); },
            error: function(xhr) { 
                let msg = xhr.responseJSON ? xhr.responseJSON.error : "Koneksi Ditolak.";
                Swal.fire("Gagal", msg, "error"); 
            },
            complete: function() { btn.prop('disabled', false).html(originalText); }
        });
    });

    // --- BACKUP BUTTON ---
    $("#backup-btn").click(function() {
        Swal.fire({
            title: "Backup Database?",
            text: "File .db akan diunduh ke komputer Anda.",
            icon: "info",
            showCancelButton: true,
            confirmButtonText: "Ya, Unduh",
            cancelButtonText: "Batal"
        }).then((result) => {
            if(result.isConfirmed) {
                // Trigger form submit tersembunyi untuk download file
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/api/backups';
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            }
        });
    });

    // --- RESTORE FORM ---
    $("#restore-form").submit(function(e) {
         e.preventDefault();
         const file = $("#restore-file")[0].files[0];
         if(!file) return Swal.fire("Perhatian", "Pilih file backup (.db) dulu.", "warning");
         
         let fd = new FormData(this);
         
         Swal.fire({
             title: "Restore Database?",
             html: "Data saat ini akan <b>DITIMPA TOTAL</b> dengan data dari backup.<br>Ketik <b>PULIHKAN</b> untuk konfirmasi:",
             input: "text",
             icon: "warning",
             showCancelButton: true,
             confirmButtonColor: "#d33",
             confirmButtonText: "RESTORE SEKARANG",
             showLoaderOnConfirm: true,
             preConfirm: (text) => {
                 if(text !== "PULIHKAN") return Swal.showValidationMessage("Konfirmasi salah.");
                 return fetch("/api/restore", {method: "POST", body: fd})
                    .then(async r => { if(!r.ok) throw new Error((await r.json()).error); });
             }
         }).then((r) => {
             if(r.isConfirmed) {
                 Swal.fire("Sukses", "Database berhasil dipulihkan. Aplikasi akan memuat ulang.", "success")
                    .then(() => location.reload());
             }
         });
    });

    // --- MIGRASI DATA FORM ---
    $('#mig_dialect').change(function() {
        // FIX: SSL UNTUK SEMUA SERVER
        $('#mig-ssl-wrap').show();
        if($(this).val() === 'postgres') {
            $('#mig_port').val('5432');
        } else {
            $('#mig_port').val('3306');
        }
    });

    $('#migration-form').submit(function(e) {
        e.preventDefault();
        let target = {
            db_dialect: $('#mig_dialect').val(),
            db_host: $('#mig_host').val(),
            db_port: $('#mig_port').val(),
            db_name: $('#mig_name').val(),
            db_user: $('#mig_user').val(),
            db_pass: $('#mig_pass').val(),
            db_sslmode: $('#mig_sslmode').val()
        };

        Swal.fire({
            title: 'Mulai Migrasi?',
            text: "Data dari database saat ini akan disalin ke database target. Pastikan target kosong.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Salin Data',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return fetch("/api/settings/migrate", {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(target)
                }).then(async r => {
                    if(!r.ok) throw new Error((await r.json()).error);
                    return r.json();
                }).catch(err => Swal.showValidationMessage(err));
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire("Migrasi Sukses!", "Data berhasil dipindahkan. Anda sekarang bisa mengubah Koneksi Database utama ke server baru.", "success");
            }
        });
    });
});
</script>