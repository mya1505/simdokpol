<script>
$(document).ready(function () {
    // --- HELPER UI ---
    $("body").on("input", ".auto-uppercase", function () { $(this).val($(this).val().toUpperCase()); });
    $("body").on("input", ".auto-titlecase", function () { 
        $(this).val($(this).val().toLowerCase().replace(/\b\w/g, s => s.toUpperCase())); 
    });

    // --- LOAD DATA AWAL (ISI SEMUA FORM) ---
    function loadSettings() {
        $.ajax({
            url: "/api/settings",
            method: "GET",
            success: function (s) {
                // FORM UMUM
                $("#kop_baris_1").val(s.kop_baris_1);
                $("#kop_baris_2").val(s.kop_baris_2);
                $("#kop_baris_3").val(s.kop_baris_3);
                $("#nama_kantor").val(s.nama_kantor);
                $("#tempat_surat").val(s.tempat_surat);
                $("#format_nomor_surat").val(s.format_nomor_surat);
                $("#nomor_surat_terakhir").val(s.nomor_surat_terakhir);
                $("#zona_waktu").val(s.zona_waktu);
                $("#archive_duration_days").val(s.archive_duration_days);
                
                // FORM DATABASE
                $("#db_dialect").val(s.db_dialect || 'sqlite');
                $("#db_dsn").val(s.db_dsn);
                $("#db_host").val(s.db_host);
                $("#db_port").val(s.db_port);
                $("#db_name").val(s.db_name);
                $("#db_user").val(s.db_user);
                $("#db_sslmode").val(s.db_sslmode || 'disable');
                
                // FORM BACKUP
                $("#backup_path").val(s.backup_path);

                toggleDBSettings(s.db_dialect || 'sqlite');
            },
            error: function() { Swal.fire("Error", "Gagal memuat data.", "error"); }
        });
    }
    loadSettings();

    // --- TOGGLE TAMPILAN DB ---
    function toggleDBSettings(dialect) {
        if (dialect === 'sqlite') {
            $('#sqlite-settings').slideDown();
            $('#server-db-settings').slideUp();
        } else {
            $('#sqlite-settings').slideUp();
            $('#server-db-settings').slideDown();
            if (dialect === 'mysql') {
                $('#db_port').attr('placeholder', '3306');
                $('#settings-pg-ssl-group').hide();
            } else {
                $('#db_port').attr('placeholder', '5432');
                $('#settings-pg-ssl-group').show();
            }
        }
    }
    $('#db_dialect').change(function() { toggleDBSettings($(this).val()); });

    // --- SUBMIT FORM: UMUM ---
    $('#general-form').submit(function(e) {
        e.preventDefault();
        submitPartialConfig({
            kop_baris_1: $("#kop_baris_1").val(),
            kop_baris_2: $("#kop_baris_2").val(),
            kop_baris_3: $("#kop_baris_3").val(),
            nama_kantor: $("#nama_kantor").val(),
            tempat_surat: $("#tempat_surat").val(),
            format_nomor_surat: $("#format_nomor_surat").val(),
            nomor_surat_terakhir: $("#nomor_surat_terakhir").val(),
            zona_waktu: $("#zona_waktu").val(),
            archive_duration_days: $("#archive_duration_days").val()
        }, "Pengaturan Umum berhasil disimpan.");
    });

    // --- SUBMIT FORM: DATABASE ---
    $('#database-form').submit(function(e) {
        e.preventDefault();
        let data = {
            db_dialect: $("#db_dialect").val(),
            db_host: $("#db_host").val(),
            db_port: $("#db_port").val(),
            db_name: $("#db_name").val(),
            db_user: $("#db_user").val(),
            db_pass: $("#db_pass").val(),
            db_sslmode: $("#db_sslmode").val()
        };
        if(data.db_pass === "") delete data.db_pass;

        submitPartialConfig(data, "Konfigurasi Database disimpan. Restart aplikasi untuk menerapkan.");
    });

    // Helper Submit
    function submitPartialConfig(data, successMsg) {
        $.ajax({
            url: "/api/settings",
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function() { Swal.fire("Sukses", successMsg, "success"); },
            error: function() { Swal.fire("Gagal", "Terjadi kesalahan.", "error"); }
        });
    }

    // --- TEST KONEKSI DB ---
    $('#test-db-btn').click(function() {
        let btn = $(this); btn.prop('disabled', true).text('Menguji...');
        let payload = {
            db_dialect: $("#db_dialect").val(),
            db_host: $("#db_host").val(),
            db_port: $("#db_port").val(),
            db_name: $("#db_name").val(),
            db_user: $("#db_user").val(),
            db_pass: $("#db_pass").val(),
            db_sslmode: $("#db_sslmode").val()
        };
        $.ajax({
            url: "/api/db/test", method: "POST",
            contentType: "application/json", data: JSON.stringify(payload),
            success: function() { Swal.fire("Sukses", "Koneksi OK!", "success"); },
            error: function() { Swal.fire("Gagal", "Koneksi ditolak.", "error"); },
            complete: function() { btn.prop('disabled', false).html('<i class="fas fa-plug mr-1"></i> Tes Koneksi'); }
        });
    });

    // --- LOGIKA RESTORE ---
    $("#restore-form").submit(function(e) {
        e.preventDefault();
        let fd = new FormData(this);
        
        Swal.fire({
            title: 'Restore Database?',
            text: "Data saat ini akan ditimpa. Lanjutkan?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Restore'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "/api/restore", method: "POST",
                    data: fd, processData: false, contentType: false,
                    success: function() { Swal.fire("Sukses", "Restore berhasil. Refresh halaman.", "success").then(()=>location.reload()); },
                    error: function() { Swal.fire("Gagal", "File backup tidak valid.", "error"); }
                });
            }
        });
    });

    // --- LOGIKA MIGRASI ---
    $('#mig_dialect').change(function() {
        if($(this).val() === 'postgres') {
            $('#mig_port').val('5432');
            $('#mig-ssl-wrap').show();
        } else {
            $('#mig_port').val('3306');
            $('#mig-ssl-wrap').hide();
        }
    });

    $('#migration-form').submit(function(e) {
        e.preventDefault();
        let target = {
            db_dialect: $('#mig_dialect').val(),
            db_host: $('#mig_host').val(),
            db_port: $('#mig_port').val(),
            db_name: $('#mig_name').val(),
            db_user: $('#mig_user').val(),
            db_pass: $('#mig_pass').val(),
            db_sslmode: $('#mig_sslmode').val()
        };

        Swal.fire({
            title: 'Mulai Migrasi?',
            text: "Data akan disalin ke database target. Proses ini tidak bisa dibatalkan.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Salin Data',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return fetch("/api/settings/migrate", {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(target)
                }).then(async r => {
                    if(!r.ok) throw new Error((await r.json()).error);
                    return r.json();
                }).catch(err => Swal.showValidationMessage(err));
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire("Sukses", "Migrasi berhasil! Anda sekarang dapat mengubah koneksi DB utama ke server baru.", "success");
            }
        });
    });
});
</script>