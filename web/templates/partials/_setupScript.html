<script>
$(document).ready(function() {
    // --- HELPER FUNCTIONS ---
    function toTitleCase(str) {
        return str.replace(/\w\S*/g, function(txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
    }
    $('body').on('input', '.auto-uppercase', function() {
        $(this).val($(this).val().toUpperCase());
    });
    $('body').on('input', '.auto-titlecase', function() {
        $(this).val(toTitleCase($(this).val()));
    });

    function togglePasswordVisibility(inputId, toggleId) {
        const password = $(inputId);
        const toggle = $(toggleId);
        const type = password.attr('type') === 'password' ? 'text' : 'password';
        password.attr('type', type);
        toggle.toggleClass('fa-eye fa-eye-slash');
    }
    $('#togglePassword').on('click', function() {
        togglePasswordVisibility('#admin_password', '#togglePassword');
    });
    $('#togglePasswordConfirm').on('click', function() {
        togglePasswordVisibility('#admin_password_confirm', '#togglePasswordConfirm');
    });
    $('#toggleDbPassword').on('click', function() {
        togglePasswordVisibility('#db_pass', '#toggleDbPassword');
    });

    // --- STEPPER LOGIC ---
    let currentSlide = 1;
    const totalSlides = 5; // 1:DB, 2:DB Config, 3:Instansi, 4:Dokumen, 5:Admin

    function showSlide(slideNumber) {
        $('.stepper-slide').removeClass('active').hide();
        $(`#slide-${slideNumber}`).fadeIn().addClass('active');
        currentSlide = slideNumber;
    }

    function validateSlide(slideNumber) {
        let isValid = true;
        $(`#slide-${slideNumber} .is-invalid`).removeClass('is-invalid');
        
        // Validasi field required yang terlihat (visible) saja
        $(`#slide-${slideNumber} [required]:visible`).each(function() {
            if ($(this).val().trim() === '') {
                isValid = false;
                $(this).addClass('is-invalid');
            }
        });
        return isValid;
    }

    // Logika Navigasi Tombol Lanjut
    $('.next-step').on('click', function() {
        if (validateSlide(currentSlide)) {
            if (currentSlide === 1) {
                const dialect = $('#db_dialect').val();
                if (dialect === 'sqlite') {
                    // Jika SQLite, lompat ke Step 3 (Instansi)
                    showSlide(3); 
                } else {
                    // Jika MySQL/Postgres, lanjut ke Step 2 (Config)
                    showSlide(2);
                }
            } else {
                if (currentSlide < totalSlides) {
                    showSlide(currentSlide + 1);
                }
            }
        } else {
            Swal.fire('Perhatian', 'Harap isi semua field yang wajib diisi.', 'warning');
        }
    });

    $('.prev-step').on('click', function() {
        if (currentSlide === 3) {
             const dialect = $('#db_dialect').val();
             // Cek apakah ini auto-jump dari env? 
             // Jika ya, kita tetap izinkan mundur ke 1 untuk ganti DB
             if (dialect === 'sqlite') {
                 showSlide(1); 
             } else {
                 // Jika MySQL/Postgres, mundur ke Step 2
                 showSlide(2); 
             }
        } else if (currentSlide > 1) {
            showSlide(currentSlide - 1);
        }
    });

    // --- DATABASE CONFIG LOGIC (PRE-FILL & AUTO-JUMP) ---
    const currentDialect = "{{.CurrentConfig.DBDialect}}";
    const currentHost = "{{.CurrentConfig.DBHost}}";

    // 1. Pre-fill Data
    if (currentDialect) {
        $('#db_dialect').val(currentDialect);
        if(currentDialect !== 'sqlite') {
            $('#db_host').val(currentHost);
            $('#db_port').val("{{.CurrentConfig.DBPort}}");
            $('#db_name').val("{{.CurrentConfig.DBName}}");
            $('#db_user').val("{{.CurrentConfig.DBUser}}");
            // Set SSL jika ada
            const currentSSL = "{{.CurrentConfig.DBSSLMode}}";
            if(currentSSL) $('#db_sslmode').val(currentSSL);
        }
    }

    // 2. Handler perubahan dropdown DB (UI Update)
    $('#db_dialect').on('change', function() {
        const dialect = $(this).val();
        
        if (dialect === 'mysql') {
            $('#db_port').attr('placeholder', '3306').val('3306');
            $('#pg-ssl-group').slideDown(); // MySQL support SSL via tls param
        } else if (dialect === 'postgres') {
            $('#db_port').attr('placeholder', '5432').val('5432');
            $('#pg-ssl-group').slideDown(); // Tampilkan SSL
        } else {
            $('#pg-ssl-group').slideUp();
        }
    });

    // Trigger change sekali di awal untuk set state UI
    $('#db_dialect').trigger('change');

    // 3. LOGIKA AUTO-JUMP JIKA SUDAH CONFIG
    // Jika dialect bukan sqlite DAN host sudah ada (berarti sudah disetup di .env sebelumnya)
    if (currentDialect && currentDialect !== 'sqlite' && currentHost) {
        console.log("Database server detected in .env, skipping DB selection steps.");
        // Langsung lompat ke Langkah 3 (Instansi)
        setTimeout(function() {
            showSlide(3);
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
            });
            Toast.fire({
                icon: 'info',
                title: 'Koneksi Database Terdeteksi',
                text: 'Melanjutkan ke konfigurasi instansi...'
            });
        }, 100);
    }

    // Handler Test Koneksi
    $('#test-db-btn').on('click', function() {
        const $btn = $(this);
        const originalHtml = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menguji...');

        const connectionData = {
            db_dialect: $('#db_dialect').val(),
            db_host: $('#db_host').val(),
            db_port: $('#db_port').val(),
            db_name: $('#db_name').val(),
            db_user: $('#db_user').val(),
            db_pass: $('#db_pass').val(),
            db_sslmode: $('#db_sslmode').val()
        };

        $.ajax({
            url: "/api/db/test",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(connectionData),
            success: function() {
                Swal.fire("Berhasil!", "Koneksi database sukses!", "success");
            },
            error: function(jqXHR) {
                const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.error : "Gagal terhubung.";
                Swal.fire("Koneksi Gagal", errorMsg, "error");
            },
            complete: function() {
                $btn.prop('disabled', false).html(originalHtml);
            }
        });
    });

    // --- FORM SUBMIT (FINAL) ---
    $('#setup-form').on('submit', function(e) {
        e.preventDefault();

        if (!validateSlide(currentSlide)) {
            Swal.fire('Perhatian', 'Harap lengkapi data di langkah terakhir.', 'warning');
            return;
        }

        const password = $('#admin_password').val();
        const confirmPassword = $('#admin_password_confirm').val();
        if (password !== confirmPassword) {
            Swal.fire('Error', 'Konfirmasi kata sandi tidak cocok!', 'error');
            return;
        }
        if (password.length < 8) {
            Swal.fire('Perhatian', 'Kata sandi minimal harus 8 karakter.', 'warning');
            return;
        }

        const formData = {
            db_dialect: $('#db_dialect').val(),
            db_host: $('#db_host').val(),
            db_port: $('#db_port').val(),
            db_name: $('#db_name').val(),
            db_user: $('#db_user').val(),
            db_pass: $('#db_pass').val(),
            db_sslmode: $('#db_sslmode').val(),
            
            kop_baris_1: $('#kop_baris_1').val(),
            kop_baris_2: $('#kop_baris_2').val(),
            kop_baris_3: $('#kop_baris_3').val(),
            nama_kantor: $('#nama_kantor').val(),
            tempat_surat: $('#tempat_surat').val(),
            
            format_nomor_surat: $('#format_nomor_surat').val(),
            nomor_surat_terakhir: $('#nomor_surat_terakhir').val(),
            zona_waktu: $('#zona_waktu').val(),
            archive_duration_days: $('#archive_duration_days').val(),
            
            admin_nama_lengkap: $('#admin_nama_lengkap').val(),
            admin_nrp: $('#admin_nrp').val(),
            admin_pangkat: $('#admin_pangkat').val(),
            admin_password: password,
        };

        const $submitButton = $(this).find('button[type="submit"]');
        $submitButton.html('<span class="spinner-border spinner-border-sm"></span> Menyimpan...').prop('disabled', true);

        $.ajax({
            url: '/api/setup',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                Swal.fire({
                    icon: 'success',
                    title: 'Setup Berhasil!',
                    text: response.message,
                    allowOutsideClick: false,
                }).then(() => {
                    window.location.href = '/login';
                });
            },
            error: function(jqXHR) {
                const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.error : 'Terjadi kesalahan yang tidak diketahui.';
                Swal.fire('Gagal', errorMsg, 'error');
                $submitButton.text('Simpan Konfigurasi & Buat Akun').prop('disabled', false);
            }
        });
    });

    // --- RESTORE LOGIC ---
    $('#restore-setup-form').on('submit', function(e) {
        e.preventDefault();
        const $submitButton = $(this).find('button[type="submit"]');
        const originalButtonText = $submitButton.html();

        const fileInput = $("#restore-file")[0];
        if (fileInput.files.length === 0) {
            Swal.fire("Perhatian!", "Silakan pilih file backup (.db) terlebih dahulu.", "warning");
            return;
        }
        
        const file = fileInput.files[0];
        if (!file.name.endsWith('.db')) {
             Swal.fire("Error", "Format file tidak valid. Harap unggah file .db", "error");
             return;
        }

        const formData = new FormData();
        formData.append("restore-file", file);

        Swal.fire({
            title: 'Pulihkan dari Backup?',
            html: `Anda akan menimpa semua data dengan file <strong>${file.name}</strong>.<br><br><strong class="text-danger">Pastikan ini adalah file backup SIMDOKPOL yang valid.</strong>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Pulihkan Sekarang!',
            cancelButtonText: 'Batal',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                $submitButton.html('<span class="spinner-border spinner-border-sm"></span> Memulihkan...').prop('disabled', true);
                return fetch("/api/setup/restore", {
                    method: "POST",
                    body: formData
                }).then(async response => {
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Gagal melakukan restore.");
                    }
                    return response.json();
                });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire(
                    'Restore Berhasil!',
                    'Database telah berhasil dipulihkan. Anda akan diarahkan ke halaman login.',
                    'success'
                ).then(() => window.location.href = '/login');
            } else {
                $submitButton.html(originalButtonText).prop('disabled', false);
            }
        }).catch(error => {
            Swal.showValidationMessage(`Request gagal: ${error}`);
            $submitButton.html(originalButtonText).prop('disabled', false);
        });
    });
});
</script>