<script>
$(document).ready(function() {
    // --- LOGIKA UI DASAR ---
    $('body').on('input', '.auto-uppercase', function() { $(this).val($(this).val().toUpperCase()); });
    $('body').on('input', '.auto-titlecase', function() { 
        $(this).val($(this).val().toLowerCase().replace(/\b\w/g, s => s.toUpperCase())); 
    });
    
    $('#toggleDbPassword').click(function() {
        let input = $('#db_pass');
        input.attr('type', input.attr('type') === 'password' ? 'text' : 'password');
        $(this).toggleClass('fa-eye fa-eye-slash');
    });

    // --- STEPPER NAVIGASI ---
    let currentStep = 1;
    function showStep(step) {
        $('.stepper-slide').removeClass('active').hide();
        $('#slide-' + step).fadeIn().addClass('active');
        currentStep = step;
    }

    $('.next-step').click(function() {
        // Validasi input di step ini
        let valid = true;
        $(`#slide-${currentStep} input[required], #slide-${currentStep} select[required]`).each(function() {
            if (!$(this).val()) { $(this).addClass('is-invalid'); valid = false; }
            else { $(this).removeClass('is-invalid'); }
        });

        if(!valid) return Swal.fire("Lengkapi Data", "Harap isi semua kolom bertanda wajib.", "warning");

        // Logika Lompat Step (SQLite skip config server)
        if (currentStep === 1) {
            if ($('#db_dialect').val() === 'sqlite') showStep(3);
            else showStep(2);
        } else {
            if(currentStep < 5) showStep(currentStep + 1);
        }
    });

    $('.prev-step').click(function() {
        if (currentStep === 3) {
            if ($('#db_dialect').val() === 'sqlite') showStep(1);
            else showStep(2);
        } else {
            showStep(currentStep - 1);
        }
    });

    // --- LOGIKA AUTO DETECT PORT & SSL ---
    $('#db_dialect').change(function() {
        let dialect = $(this).val();
        if (dialect === 'mysql') {
            $('#db_port').val('3306');
            $('#pg-ssl-group').slideUp();
        } else if (dialect === 'postgres') {
            $('#db_port').val('5432');
            $('#pg-ssl-group').slideDown(); // Tampilkan SSL hanya untuk Postgres
        }
    });

    // Pre-fill jika ada config dari .env (Auto Jump)
    let envDialect = "{{.CurrentConfig.DBDialect}}";
    if (envDialect && envDialect !== 'sqlite') {
        $('#db_dialect').val(envDialect).trigger('change');
        $('#db_host').val("{{.CurrentConfig.DBHost}}");
        $('#db_name').val("{{.CurrentConfig.DBName}}");
        $('#db_user').val("{{.CurrentConfig.DBUser}}");
        // Auto jump ke step 3 jika sudah terkoneksi
        if ("{{.CurrentConfig.DBHost}}") {
            setTimeout(() => showStep(3), 500);
        }
    }

    // --- TEST KONEKSI ---
    $('#test-db-btn').click(function() {
        let btn = $(this);
        let originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Menguji...');

        let payload = {
            db_dialect: $('#db_dialect').val(),
            db_host: $('#db_host').val(),
            db_port: $('#db_port').val(),
            db_name: $('#db_name').val(),
            db_user: $('#db_user').val(),
            db_pass: $('#db_pass').val(),
            db_sslmode: $('#db_sslmode').val()
        };

        $.ajax({
            url: '/api/db/test',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function() {
                Swal.fire("Sukses", "Koneksi database berhasil!", "success");
            },
            error: function(xhr) {
                let msg = xhr.responseJSON ? xhr.responseJSON.error : "Gagal terkoneksi.";
                Swal.fire("Gagal", msg, "error");
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // --- SUBMIT FINAL ---
    $('#setup-form').submit(function(e) {
        e.preventDefault();
        
        // Validasi Password Admin
        let p1 = $('#admin_password').val();
        let p2 = $('#admin_password_confirm').val();
        if (p1 !== p2) return Swal.fire("Error", "Konfirmasi password tidak cocok.", "error");

        let formData = {
            db_dialect: $('#db_dialect').val(),
            db_host: $('#db_host').val(),
            db_port: $('#db_port').val(),
            db_name: $('#db_name').val(),
            db_user: $('#db_user').val(),
            db_pass: $('#db_pass').val(),
            db_sslmode: $('#db_sslmode').val(),

            kop_baris_1: $('#kop_baris_1').val(),
            kop_baris_2: $('#kop_baris_2').val(),
            kop_baris_3: $('#kop_baris_3').val(),
            nama_kantor: $('#nama_kantor').val(),
            tempat_surat: $('#tempat_surat').val(),

            format_nomor_surat: $('#format_nomor_surat').val(),
            nomor_surat_terakhir: $('#nomor_surat_terakhir').val(),
            zona_waktu: $('#zona_waktu').val(),
            archive_duration_days: $('#archive_duration_days').val(),

            admin_nama_lengkap: $('#admin_nama_lengkap').val(),
            admin_nrp: $('#admin_nrp').val(),
            admin_pangkat: $('#admin_pangkat').val(),
            admin_password: p1
        };

        $.ajax({
            url: '/api/setup',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                Swal.fire("Setup Selesai", "Konfigurasi tersimpan. Silakan login.", "success")
                    .then(() => window.location.href = '/login');
            },
            error: function(xhr) {
                Swal.fire("Gagal", xhr.responseJSON ? xhr.responseJSON.error : "Terjadi kesalahan.", "error");
            }
        });
    });

    // --- RESTORE SETUP ---
    $('#restore-setup-form').submit(function(e) {
        e.preventDefault();
        let formData = new FormData(this);
        
        $.ajax({
            url: '/api/setup/restore',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function() {
                Swal.fire("Restore Sukses", "Database dipulihkan.", "success")
                    .then(() => window.location.href = '/login');
            },
            error: function(xhr) {
                Swal.fire("Gagal", xhr.responseJSON ? xhr.responseJSON.error : "Gagal restore.", "error");
            }
        });
    });
    
    // Nama file di input file
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').addClass("selected").html(fileName);
    });
});
</script>