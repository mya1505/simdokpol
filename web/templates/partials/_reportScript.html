<script>
$(document).ready(function() {
    // Inisialisasi Datepicker
    const commonDatepickerOptions = {
        format: 'dd-mm-yyyy',
        language: 'id',
        autoclose: true,
        todayHighlight: true,
        endDate: '0d' // Hanya bisa memilih hari ini atau sebelumnya
    };

    $('#start_date').datepicker(commonDatepickerOptions);
    $('#end_date').datepicker(commonDatepickerOptions);

    // Set default ke 7 hari terakhir
    const today = new Date();
    // const lastWeek = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000); // 6 hari lalu + hari ini = 7 hari
    
    // --- PERBAIKAN BUG #5 DI SINI ---
    // $('#start_date').datepicker('update', lastWeek); // Dihapus/dikomentari agar default-nya placeholder
    // --- AKHIR PERBAIKAN ---
    
    $('#end_date').datepicker('update', today); // Tanggal selesai tetap hari ini

    // Handler submit form
    $('#report-form').on('submit', function(e) {
        e.preventDefault();

        const $btn = $('#generate-report-btn');
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Generating...');

        // 1. Ambil dan format tanggal
        const startDateVal = $('#start_date').val();
        const endDateVal = $('#end_date').val();

        if (!startDateVal || !endDateVal) {
            Swal.fire("Perhatian", "Tanggal mulai dan tanggal selesai wajib diisi.", "warning");
            $btn.prop('disabled', false).html(originalText);
            return;
        }

        // Konversi DD-MM-YYYY ke YYYY-MM-DD
        const [startDay, startMonth, startYear] = startDateVal.split('-');
        const isoStartDate = `${startYear}-${startMonth}-${startDay}`;

        const [endDay, endMonth, endYear] = endDateVal.split('-');
        const isoEndDate = `${endYear}-${endMonth}-${endDay}`;

        // 2. Buat URL API
        const params = new URLSearchParams({
            start_date: isoStartDate,
            end_date: isoEndDate
        });
        const apiUrl = '/api/reports/aggregate/pdf?' + params.toString();

        // 3. Panggil API menggunakan fetch (lebih baik untuk blob/file)
        fetch(apiUrl)
            .then(async res => {
                if (!res.ok) {
                    // Jika error, coba baca JSON
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || `Gagal membuat laporan. Status: ${res.status}`);
                }
                
                // Dapatkan nama file dari header
                const disposition = res.headers.get("Content-Disposition");
                let filename = "laporan_agregat.pdf";
                if (disposition) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, "");
                    }
                }
                return res.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                // 4. Trigger download
                const a = document.createElement("a");
                a.href = window.URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                
                Swal.fire("Berhasil!", "File PDF laporan berhasil diunduh.", "success");
            })
            .catch(err => {
                Swal.fire("Gagal!", err.message, "error");
            })
            .finally(() => {
                $btn.prop('disabled', false).html(originalText);
            });
    });
});
</script>