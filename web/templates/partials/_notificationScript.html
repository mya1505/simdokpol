<script>
$(document).ready(function() {
    function loadNotifications() {
        const $counter = $('#notification-counter');
        const $list = $('#notification-list');
        const MAX_DISPLAY = 5; 

        // 1. Ambil Config Durasi Arsip
        $.ajax({
            url: '/api/config/limits',
            method: 'GET',
            success: function(config) {
                const archiveDurationDays = config.archive_duration_days || 15;
                fetchExpiringDocs(archiveDurationDays, $counter, $list, MAX_DISPLAY);
            },
            error: function() {
                fetchExpiringDocs(15, $counter, $list, MAX_DISPLAY);
            }
        });
    }

    function fetchExpiringDocs(archiveDurationDays, $counter, $list, maxDisplay) {
        $.ajax({
            url: '/api/notifications/expiring-documents',
            method: 'GET',
            success: function(docs) {
                if (!docs || docs.length === 0) {
                    $counter.hide();
                    $list.html(`
                        <a class="dropdown-item d-flex align-items-center" href="#">
                            <div class="mr-3">
                                <div class="icon-circle bg-success">
                                    <i class="fas fa-check text-white"></i>
                                </div>
                            </div>
                            <div>
                                <span class="font-weight-bold">Tidak ada notifikasi baru.</span>
                            </div>
                        </a>
                    `);
                    return;
                }

                $counter.text(docs.length).show();
                $list.empty(); // BERSIHKAN ISI LAMA

                const now = new Date();
                const displayDocs = docs.slice(0, maxDisplay);

                displayDocs.forEach(doc => {
                    const reportDate = new Date(doc.tanggal_laporan);
                    const expiryDate = new Date(reportDate.getTime());
                    expiryDate.setDate(reportDate.getDate() + archiveDurationDays);
                    const diffTime = expiryDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let expiryText = '';
                    let iconClass = 'bg-warning';
                    
                    if (diffDays > 1) {
                        expiryText = `Akan diarsip dalam ${diffDays} hari.`;
                    } else if (diffDays <= 1 && diffDays >= 0) {
                        expiryText = 'Segera diarsip (Besok/Hari Ini).';
                        iconClass = 'bg-danger';
                    } else {
                        expiryText = 'Sudah lewat masa aktif.';
                        iconClass = 'bg-secondary';
                    }

                    const notificationItem = `
                        <a class="dropdown-item d-flex align-items-center" href="/documents/${doc.id}/edit">
                            <div class="mr-3">
                                <div class="icon-circle ${iconClass}">
                                    <i class="fas fa-file-alt text-white"></i>
                                </div>
                            </div>
                            <div>
                                <div class="small text-gray-500">${new Date(doc.tanggal_laporan).toLocaleDateString('id-ID')}</div>
                                <span class="font-weight-bold">${doc.nomor_surat}</span><br>
                                <span class="small">${expiryText}</span>
                            </div>
                        </a>
                    `;
                    $list.append(notificationItem);
                });

                // Footer Link: Dinamis + Filter
                const remaining = docs.length - displayDocs.length;
                let footerText = "Lihat Semua Notifikasi";
                if (remaining > 0) {
                    footerText = `Lihat ${remaining} Lainnya & Semua Notifikasi`;
                }

                $list.append(`
                    <a class="dropdown-item text-center small text-gray-500 bg-light border-top font-weight-bold py-3" href="/documents?filter=expiring">
                        ${footerText} <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                `);
            },
            error: function(xhr) {
                $list.html(`<div class="p-3 text-center small text-danger">Gagal memuat notifikasi.</div>`);
            }
        });
    }

    loadNotifications();
    setInterval(loadNotifications, 300000); 
});
</script>