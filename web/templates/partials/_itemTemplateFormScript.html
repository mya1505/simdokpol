<script>
$(document).ready(function() {
    const isEdit = {{.IsEdit}};
    const templateID = {{.TemplateID}};

    // Helper
    function toTitleCase(str) { return str.replace(/\w\S*/g, function(txt) { return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); }); }
    $('body').on('input', '.auto-uppercase', function() { $(this).val($(this).val().toUpperCase()); });
    $('body').on('input', '.auto-titlecase', function() { $(this).val(toTitleCase($(this).val())); });

    const fieldsContainer = document.getElementById('fields-container');
    
    // --- INISIALISASI SORTABLE JS ---
    if (typeof Sortable !== 'undefined') {
        new Sortable(fieldsContainer, {
            animation: 150,
            handle: '.header-drag-handle', 
            ghostClass: 'bg-light', 
            onEnd: function() {
                updateFieldNumbers();
            }
        });
    } else {
        console.error("SortableJS library not found! Drag & Drop disabled.");
    }

    let fieldCounter = 0;
    
    function updateFieldNumbers() {
        $('#fields-container .field-item').each(function(index) {
            $(this).find('.title-text').text(`Field #${index + 1}`);
        });
        if ($('#fields-container .field-item').length === 0) {
            $('#empty-fields-msg').show();
        } else {
            $('#empty-fields-msg').hide();
        }
    }

    function addField(data = null) {
        $('#empty-fields-msg').hide();
        fieldCounter++;
        
        const template = document.getElementById('field-item-template');
        const clone = template.content.cloneNode(true);
        const $clone = $(clone);
        
        // Fix ID unik untuk checkbox
        const uniqueId = 'req_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        $clone.find('.field-required').attr('id', uniqueId);
        $clone.find('label[for="req_NEWID"]').attr('for', uniqueId);
        
        // Jika ada data (dari edit mode), isi fieldnya
        if (data) {
            $clone.find('[data-key="label"]').val(data.label);
            $clone.find('[data-key="type"]').val(data.type);
            $clone.find('[data-key="data_label"]').val(data.data_label);
            $clone.find('[data-key="placeholder"]').val(data.placeholder);
            
            // Set checkbox required
            if (data.required_length > 0 || data.min_length > 0) { // Asumsi logic backend untuk required
                 $clone.find('[data-key="required_length"]').prop('checked', true);
            }
        }
        
        $('#fields-container').append($clone);
        updateFieldNumbers();
    }

    $('#add-field-btn').on('click', function() {
        addField();
    });

    $('body').on('click', '.remove-field-btn', function() {
        $(this).closest('.field-item').remove();
        updateFieldNumbers();
    });

    // --- POPULATE DATA (EDIT MODE) ---
    if (isEdit) {
        // Menggunakan .html() agar ICON terbaca
        $('#page-title').html('<i class="fas fa-edit mr-2 text-gray-400"></i>Edit Template Barang');
        $('#submit-btn').html('<i class="fas fa-save mr-2"></i> Simpan Perubahan');
        
        $.ajax({
            url: `/api/item-templates/${templateID}`,
            method: 'GET',
            success: function(data) {
                $('#nama_barang').val(data.nama_barang);
                $('#urutan').val(data.urutan);
                $('#is_active').prop('checked', data.is_active); 
                
                if (data.fields_config && data.fields_config.length > 0) {
                    data.fields_config.forEach(field => addField(field));
                }
            },
            error: function() { 
                Swal.fire('Error', 'Gagal memuat data template.', 'error').then(() => {
                    window.location.href = '/templates';
                });
            }
        });
    }

    // --- SUBMIT FORM ---
    $('#template-form').on('submit', function(e) {
        e.preventDefault();
        const $btn = $('#submit-btn');
        const originalHtml = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menyimpan...');

        // Kumpulkan data fields
        const fieldsConfig = [];
        let validationError = false;

        $('#fields-container .field-item').each(function() {
            const $card = $(this);
            const label = $card.find('[data-key="label"]').val();
            const dataLabel = $card.find('[data-key="data_label"]').val();
            const isRequired = $card.find('[data-key="required_length"]').is(':checked');
            
            if (!label || !dataLabel) {
                Swal.fire('Input Tidak Lengkap', 'Setiap field harus memiliki "Label Form" dan "Data Label".', 'warning');
                validationError = true;
                return false; 
            }

            // Logic sederhana mapping checkbox 'Wajib' ke required_length (bisa disesuaikan kebutuhan)
            // Di sini kita set min_length 1 sebagai tanda required jika checkbox dicentang
            let reqLen = 0;
            let minLen = 0;
            if(isRequired) {
                minLen = 1; 
            }

            fieldsConfig.push({
                label: label,
                type: $card.find('[data-key="type"]').val(),
                data_label: dataLabel,
                placeholder: $card.find('[data-key="placeholder"]').val(),
                min_length: minLen
            });
        });

        if (validationError) {
            $btn.prop('disabled', false).html(originalHtml);
            return;
        }

        const formData = {
            nama_barang: $('#nama_barang').val(),
            urutan: parseInt($('#urutan').val()),
            is_active: $('#is_active').is(':checked'),
            fields_config: fieldsConfig
        };

        let ajaxSettings = {
            url: '/api/item-templates',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: 'Template berhasil disimpan.',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => window.location.href = '/templates');
            },
            error: function(jqXHR) {
                const msg = jqXHR.responseJSON ? jqXHR.responseJSON.error : 'Terjadi kesalahan.';
                Swal.fire('Gagal', msg, 'error');
            },
            complete: function() {
                $btn.prop('disabled', false).html(originalHtml);
            }
        };

        if (isEdit) {
            ajaxSettings.url = `/api/item-templates/${templateID}`;
            ajaxSettings.method = 'PUT';
        }

        $.ajax(ajaxSettings);
    });
});
</script>