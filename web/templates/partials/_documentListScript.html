<script>
$(document).ready(function() {
    let dataTableInstance;
    const $table = $('#documentsTable');
    
    const currentUserID = parseInt($table.data('current-user-id')) || 0;
    const currentUserPeran = $table.data('current-user-peran');
    const pageType = $table.data('page-type'); 

    // --- Cek URL Parameters ---
    const urlParams = new URLSearchParams(window.location.search);
    const initialSearch = urlParams.get('q') || "";
    const filterType = urlParams.get('filter') || ""; // Ambil param filter

    // --- Update Judul Halaman Sesuai Konteks ---
    if (initialSearch) {
        $('#page-title').html(`<i class="fas fa-search mr-2"></i>Hasil Pencarian: "${initialSearch}"`);
        $('#page-description').hide();
    } else if (filterType === 'expiring') {
        // UI Khusus Mode Notifikasi
        $('#page-title').html(`<i class="fas fa-exclamation-triangle text-warning mr-2"></i>Dokumen Segera Berakhir`);
        $('#page-description').html(`
            <div class="alert alert-warning border-left-warning shadow-sm">
                <strong>Filter Aktif:</strong> Menampilkan dokumen yang masa berlakunya akan habis dalam 3 hari ke depan.
                <a href="/documents" class="float-right text-decoration-none small font-weight-bold">Hapus Filter <i class="fas fa-times"></i></a>
            </div>
        `);
    }

    // --- Handler Export Excel ---
    $('#export-excel-btn').on('click', function() {
        const query = dataTableInstance.search(); 
        const params = new URLSearchParams();
        params.append('status', pageType); 
        if (query) params.append('q', query);
        if (filterType) params.append('filter', filterType); // Ikutkan filter saat export
        window.location.href = '/api/documents/export?' + params.toString();
    });

    // --- Init DataTables ---
    dataTableInstance = $table.DataTable({
        "processing": true,
        "serverSide": true, 
        "responsive": true,
        "search": { "search": initialSearch },
        "ajax": {
            "url": "/api/documents",
            "type": "GET",
            "data": function(d) {
                d.status = pageType; 
                d.filter_type = filterType; // Kirim parameter ke Backend
            },
            "error": function(xhr, error, code) {
                console.error("DataTables Error:", error);
                $('#documentsTable tbody').html('<tr><td colspan="7" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Gagal memuat data.</td></tr>');
                $("#documentsTable_processing").css("display", "none");
            }
        },
        "columns": [
            // ... (Kolom-kolom SAMA PERSIS dengan sebelumnya, tidak ada perubahan) ...
            // Copas bagian columns dari script sebelumnya di sini
            { 
                "data": null, 
                "orderable": false,
                "searchable": false,
                "render": function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                }
            },
            { "data": "nomor_surat", "name": "nomor_surat", "render": $.fn.dataTable.render.text() }, 
            { 
                "data": "resident.nama_lengkap", 
                "defaultContent": "<em>Tanpa Nama</em>",
                "name": "resident.nama_lengkap",
                "render": function(data) { return data ? $("<div>").text(data).html() : "<em>Tanpa Nama</em>"; }
            },
            { 
                "data": "tanggal_laporan", 
                "name": "tanggal_laporan",
                "render": function(data) {
                    if (!data) return "-";
                    return new Date(data).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                }
            },
            { 
                "data": "status", 
                "name": "status",
                "render": function(data) {
                    return (data === 'DIARSIPKAN') ? `<span class="badge badge-secondary">${data}</span>` : `<span class="badge badge-success">${data}</span>`;
                }
            },
            { 
                "data": "operator.nama_lengkap", 
                "defaultContent": "<em>Sistem/Terhapus</em>",
                "name": "operator.nama_lengkap",
                "render": function(data) { return data ? $("<div>").text(data).html() : "<em>Sistem</em>"; }
            },
            {
                "data": "id",
                "orderable": false,
                "searchable": false,
                "render": function(data, type, row) {
                    const opID = row.operator ? row.operator.id : 0;
                    const isOwner = opID === currentUserID;
                    const isAdmin = currentUserPeran === 'SUPER_ADMIN';
                    const canModify = isOwner || isAdmin;
                    
                    let buttons = `<div class="btn-group" role="group">`;
                    buttons += `<a href="/api/documents/${data}/pdf" class="btn btn-danger btn-sm" title="PDF" target="_blank"><i class="fas fa-file-pdf"></i></a>`;
                    buttons += `<a href="/documents/${data}/print" class="btn btn-info btn-sm" title="Print"><i class="fas fa-print"></i></a>`;
                    buttons += `<a href="/documents/new?duplicate_from=${data}" class="btn btn-success btn-sm" title="Copy"><i class="fas fa-copy"></i></a>`;

                    if (canModify) {
                        buttons += `<a href="/documents/${data}/edit" class="btn btn-warning btn-sm" title="Edit"><i class="fas fa-edit"></i></a>`;
                        buttons += `<button type="button" class="btn btn-danger btn-sm delete-btn" data-id="${data}" data-number="${row.nomor_surat}" title="Hapus"><i class="fas fa-trash"></i></button>`;
                    } else {
                        buttons += `<button class="btn btn-secondary btn-sm disabled" disabled><i class="fas fa-edit"></i></button>`;
                        buttons += `<button class="btn btn-secondary btn-sm disabled" disabled><i class="fas fa-trash"></i></button>`;
                    }
                    buttons += `</div>`;
                    return buttons;
                }
            }
        ],
        "language": { "url": "/static/vendor/datatables/Indonesian.json" },
        "order": [[ 3, "asc" ]], // PENTING: Urutkan dari yg paling lama (ASC) biar yg mau expired muncul duluan
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]]
    });

    // --- Handler Delete (Sama) ---
    $('#documentsTable').on('click', '.delete-btn', function() {
        const docId = $(this).data('id');
        const docNumber = $(this).data('number');
        Swal.fire({
            title: 'Hapus Dokumen?',
            text: `Nomor: ${docNumber}`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/api/documents/' + docId,
                    method: 'DELETE',
                    success: function() {
                        Swal.fire('Terhapus!', 'Dokumen berhasil dihapus.', 'success');
                        dataTableInstance.ajax.reload(null, false); 
                    },
                    error: function() { Swal.fire('Gagal', 'Terjadi kesalahan.', 'error'); }
                });
            }
        });
    });
});
</script>