<script>
$(document).ready(function() {
    let dataTableInstance;
    const $table = $('#documentsTable');
    
    // Ambil metadata dari atribut HTML
    const currentUserID = parseInt($table.data('current-user-id')) || 0;
    const currentUserPeran = $table.data('current-user-peran');
    const pageType = $table.data('page-type'); // 'active' atau 'archived'

    // --- 1. HANDLER EKSPOR EXCEL ---
    $('#export-excel-btn').on('click', function() {
        const query = dataTableInstance.search(); 
        const params = new URLSearchParams();
        params.append('status', pageType); 
        if (query) {
            params.append('q', query);
        }
        window.location.href = '/api/documents/export?' + params.toString();
    });

    // --- 2. INITIALIZATION DATATABLES (SERVER-SIDE) ---
    const urlParams = new URLSearchParams(window.location.search);
    const initialSearch = urlParams.get('q') || "";

    if (initialSearch) {
        $('#page-title').text(`Hasil Pencarian: "${initialSearch}"`);
        $('#page-description').hide();
    }

    dataTableInstance = $table.DataTable({
        "processing": true,
        "serverSide": true, 
        "responsive": true,
        "search": {
            "search": initialSearch 
        },
        "ajax": {
            "url": "/api/documents",
            "type": "GET",
            "data": function(d) {
                d.status = pageType; 
            },
            "error": function(xhr, error, code) {
                console.error("DataTables Error:", error);
                $('#documentsTable tbody').html('<tr><td colspan="7" class="text-center text-danger"><i class="fas fa-exclamation-triangle"></i> Gagal memuat data dari server.</td></tr>');
                $("#documentsTable_processing").css("display", "none");
            }
        },
        "columns": [
            { 
                "data": null, 
                "orderable": false,
                "searchable": false,
                "render": function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                }
            },
            // SECURITY FIX: Render Text Murni (Anti-XSS)
            { 
                "data": "nomor_surat", 
                "name": "nomor_surat",
                "render": $.fn.dataTable.render.text()
            }, 
            { 
                "data": "resident.nama_lengkap", 
                "defaultContent": "<em>Tanpa Nama</em>",
                "name": "resident.nama_lengkap",
                "render": function(data, type, row) {
                    if (!data) return "<em>Tanpa Nama</em>";
                    // Manual Escape HTML untuk data nested
                    return $("<div>").text(data).html();
                }
            },
            { 
                "data": "tanggal_laporan", 
                "name": "tanggal_laporan",
                "render": function(data) {
                    if (!data) return "-";
                    return new Date(data).toLocaleDateString('id-ID', { 
                        day: '2-digit', month: 'long', year: 'numeric' 
                    });
                }
            },
            { 
                "data": "status", 
                "name": "status",
                "render": function(data) {
                    if (data === 'DIARSIPKAN') {
                        return `<span class="badge badge-secondary">${data}</span>`;
                    }
                    return `<span class="badge badge-success">${data}</span>`;
                }
            },
            { 
                "data": "operator.nama_lengkap", 
                "defaultContent": "<em>Sistem/Terhapus</em>",
                "name": "operator.nama_lengkap",
                "render": function(data) {
                    if (!data) return "<em>Sistem/Terhapus</em>";
                    // Manual Escape HTML
                    return $("<div>").text(data).html();
                }
            },
            {
                // Kolom Aksi (HTML Safe karena generated di sini)
                "data": "id",
                "orderable": false,
                "searchable": false,
                "render": function(data, type, row) {
                    const opID = row.operator ? row.operator.id : 0;
                    const isOwner = opID === currentUserID;
                    const isAdmin = currentUserPeran === 'SUPER_ADMIN';
                    const canModify = isOwner || isAdmin;
                    
                    let buttons = `<div class="btn-group" role="group">`;
                    
                    buttons += `<a href="/api/documents/${data}/pdf" class="btn btn-danger btn-sm" title="Download PDF" target="_blank">
                                    <i class="fas fa-file-pdf"></i><span class="btn-caption">PDF</span>
                                </a>`;
                                
                    buttons += `<a href="/documents/${data}/print" class="btn btn-info btn-sm" title="Preview Cetak">
                                    <i class="fas fa-print"></i><span class="btn-caption">Preview</span>
                                </a>`;
                                
                    buttons += `<a href="/documents/new?duplicate_from=${data}" class="btn btn-success btn-sm" title="Buat Ulang">
                                    <i class="fas fa-copy"></i><span class="btn-caption">Copy</span>
                                </a>`;

                    if (canModify) {
                        buttons += `<a href="/documents/${data}/edit" class="btn btn-warning btn-sm" title="Edit">
                                        <i class="fas fa-edit"></i><span class="btn-caption">Edit</span>
                                    </a>`;
                        
                        buttons += `<button type="button" class="btn btn-danger btn-sm delete-btn" 
                                        data-id="${data}" 
                                        data-number="${row.nomor_surat}" 
                                        title="Hapus">
                                        <i class="fas fa-trash"></i><span class="btn-caption">Hapus</span>
                                    </button>`;
                    } else {
                        buttons += `<button class="btn btn-secondary btn-sm disabled" disabled><i class="fas fa-edit"></i></button>`;
                        buttons += `<button class="btn btn-secondary btn-sm disabled" disabled><i class="fas fa-trash"></i></button>`;
                    }

                    buttons += `</div>`;
                    return buttons;
                }
            }
        ],
        "language": {
            "url": "/static/vendor/datatables/Indonesian.json" 
        },
        "order": [[ 3, "desc" ]],
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]]
    });

    // --- 3. HANDLER DELETE ---
    $('#documentsTable').on('click', '.delete-btn', function() {
        const docId = $(this).data('id');
        const docNumber = $(this).data('number');
        
        Swal.fire({
            title: 'Hapus Dokumen?',
            html: `Anda akan menghapus surat nomor: <strong>${docNumber}</strong>.<br><small class="text-muted">Data tidak akan hilang permanen (soft delete), tapi tidak akan muncul di daftar.</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({title: 'Memproses...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
                
                $.ajax({
                    url: '/api/documents/' + docId,
                    method: 'DELETE',
                    success: function(response) {
                        Swal.fire('Terhapus!', 'Dokumen berhasil dihapus.', 'success');
                        dataTableInstance.ajax.reload(null, false); 
                    },
                    error: function(jqXHR) {
                        const msg = jqXHR.responseJSON ? jqXHR.responseJSON.error : 'Gagal menghapus data.';
                        Swal.fire('Gagal', msg, 'error');
                    }
                });
            }
        });
    });
});
</script>