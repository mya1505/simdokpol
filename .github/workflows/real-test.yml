name: Real E2E System Test

on: [push, pull_request, workflow_dispatch]

jobs:
  e2e-test:
    name: Test Running Application (E2E)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.0'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # Walaupun headless, library Gtk tetap dibutuhkan untuk kompilasi systray
          sudo apt-get install -y gcc libgtk-3-dev libayatana-appindicator3-dev
          go mod tidy

      - name: Build Application
        run: |
          go build -o simdokpol cmd/main.go
          chmod +x simdokpol

      - name: Run Application in Background (Headless)
        run: |
          export PORT=8080
          export JWT_SECRET_KEY=rahasia-test-e2e
          # AKTIFKAN MODE HEADLESS
          export HEADLESS_MODE=true
          
          # Jalankan app
          ./simdokpol > app.log 2>&1 &
          
          echo "â³ Menunggu aplikasi booting..."
          sleep 5

      - name: Run Real E2E Test
        run: |
          echo "ğŸš€ Menjalankan Skenario User..."
          go test -v ./tests/e2e/...

      - name: Print App Logs (Jika Gagal)
        if: failure()
        run: |
          echo "=== LOG APLIKASI ==="
          cat app.log