name: Real E2E System Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  e2e-test:
    name: Test Running Application (E2E)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.0'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libgtk-3-dev libayatana-appindicator3-dev xvfb
          go mod tidy

      - name: Build Application
        run: |
          go build -o simdokpol cmd/main.go
          chmod +x simdokpol

      - name: Run Application in Background
        run: |
          # Setup Virtual Display
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          export DISPLAY=:99
          
          # FIX: JANGAN set DB_DSN di sini! 
          # Biarkan aplikasi start dengan default (sqlite di AppData),
          # lalu Test Script akan melakukan Setup Wizard untuk menimpa config via .env
          
          export PORT=8080
          export JWT_SECRET_KEY=rahasia-test-e2e
          
          # Jalankan app
          ./simdokpol > app.log 2>&1 &
          
          echo "â³ Menunggu aplikasi booting..."
          sleep 5

      - name: Run Real E2E Test
        run: |
          echo "ğŸš€ Menjalankan Skenario User..."
          # Test script akan: 
          # 1. Hit /setup untuk konfigurasi DB ke path absolut test
          # 2. Register Admin
          # 3. Login & Test Fitur
          go test -v ./tests/e2e/...

      - name: Print App Logs (Jika Gagal)
        if: failure()
        run: |
          echo "=== LOG APLIKASI ==="
          cat app.log