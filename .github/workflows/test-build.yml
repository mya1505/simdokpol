name: Test Cross-Platform Build

on:
  workflow_dispatch:  # Hanya bisa dijalankan manual lewat tombol "Run workflow"
  # pull_request:
  #   paths:
  #     - 'cmd/**'
  #     - 'internal/**'
  #     - 'web/**'
  #     - 'go.mod'
  #     - 'go.sum'
  #     - '.github/workflows/test-build.yml'
  # push:
  #   branches:
  #     - main
  #     - develop

env:
  APP_NAME: simdokpol
  GO_VERSION: '1.25'
  TEST_DIR: test-output

jobs:
  #=================================================
  # JOB 1: Unit Tests (Go Only)
  #=================================================
  unit-tests:
    name: Run Go Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Download Dependencies
        run: go mod tidy
      
      - name: Install CGO dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc libgtk-3-dev libayatana-appindicator3-dev xvfb

      - name: Start virtual display (for GUI tests)
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          sleep 2

      - name: Run Go Unit Tests
        env:
          DISPLAY: :99
        run: |
          echo "=========================================="
          echo "Menjalankan unit tests dengan race detector"
          echo "=========================================="
          go test -v -race ./internal/...
          echo "âœ… Unit tests completed successfully"
      
      - name: Cleanup virtual display
        if: always()
        run: |
          if [ -n "$XVFB_PID" ]; then
            kill $XVFB_PID 2>/dev/null || true
          fi

  #=================================================
  # JOB 2: Integration Test (SQLite)
  #=================================================
  integration-test-sqlite:
    name: Integration Test (SQLite)
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- PERBAIKAN SINTAKS YAML (Baris 80-81) ---
      - name: Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: ${{ env.GO_VERSION }}
          cache: true
      # --- AKHIR PERBAIKAN ---

      - name: Download Dependencies
        run: go mod tidy
      - name: Install CGO dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc libgtk-3-dev libayatana-appindicator3-dev
      
      - name: Build Seeder
        env: 
          CGO_ENABLED: 1
        run: |
          echo "Building seeder for SQLite..."
          go build -v -o ./seeder ./cmd/seeder/main.go

      - name: Run SQLite Seeder (Stress Test)
        env:
          DB_DIALECT: "sqlite"
          DB_DSN: "seeder_test_db.sqlite?_foreign_keys=on"
          JWT_SECRET_KEY: "jwt-test-secret"
          BCRYPT_COST: "4"
        run: |
          echo "=========================================="
          echo "Running SQLite Integration Stress Test (Seeder)"
          echo "=========================================="
          ./seeder
          echo "âœ… SQLite Seeder Test PASSED"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: sqlite-integration-logs
          path: seeder_test_db.sqlite*
          retention-days: 7

  #=================================================
  # JOB 3: Integration Test (MySQL)
  #=================================================
  integration-test-mysql:
    name: Integration Test (MySQL)
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: test_db
        ports: ['3306:3306']
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot_password"
          --health-interval=10s --health-timeout=5s --health-retries=10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download Dependencies
        run: go mod tidy
      - name: Install Dependencies (GCC & MySQL Client)
        run: sudo apt-get update && sudo apt-get install -y gcc mysql-client
      
      - name: Verify MySQL Connection
        run: |
          echo "Verifying MySQL service..."
          mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"root_password" --wait=30
          echo "âœ… MySQL connection verified!"
      
      - name: Build Seeder
        env: 
          CGO_ENABLED: 1
        run: |
          echo "Building seeder for MySQL..."
          go build -v -o ./seeder ./cmd/seeder/main.go
      
      - name: Run MySQL Seeder (Stress Test)
        env:
          DB_DIALECT: "mysql"
          DB_HOST: "127.0.0.1"
          DB_PORT: "3306"
          DB_USER: "root"
          DB_PASS: "root_password"
          DB_NAME: "test_db"
          JWT_SECRET_KEY: "jwt-test-secret"
          BCRYPT_COST: "4"
        run: |
          echo "=========================================="
          echo "Running MySQL Integration Stress Test (Seeder)"
          echo "=========================================="
          ./seeder
          echo "âœ… MySQL Seeder Test PASSED"

  #=================================================
  # JOB 4: Integration Test (PostgreSQL)
  #=================================================
  integration-test-postgres:
    name: Integration Test (PostgreSQL)
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: root_password
          POSTGRES_DB: test_db
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U postgres -d test_db"
          --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download Dependencies
        run: go mod tidy
      - name: Install Dependencies (GCC & PostgreSQL Client)
        run: sudo apt-get update && sudo apt-get install -y gcc postgresql-client
      
      - name: Verify PostgreSQL Connection
        env:
          PGPASSWORD: root_password
        run: |
          echo "Verifying PostgreSQL service..."
          pg_isready -h "127.0.0.1" -p "5432" -U "postgres" -d "test_db" --timeout=30
          echo "âœ… PostgreSQL connection verified!"
      
      - name: Build Seeder
        env: 
          CGO_ENABLED: 1
        run: |
          echo "Building seeder for PostgreSQL..."
          go build -v -o ./seeder ./cmd/seeder/main.go
      
      - name: Run PostgreSQL Seeder (Stress Test)
        env:
          DB_DIALECT: "postgres"
          DB_HOST: "127.0.0.1"
          DB_PORT: "5432"
          DB_USER: "postgres"
          DB_PASS: "root_password"
          DB_NAME: "test_db"
          JWT_SECRET_KEY: "jwt-test-secret"
          BCRYPT_COST: "4"
        run: |
          echo "=========================================="
          echo "Running PostgreSQL Integration Stress Test (Seeder)"
          echo "=========================================="
          ./seeder
          echo "âœ… PostgreSQL Seeder Test PASSED"

  #=================================================
  # JOB 5: Test Build di Windows (x64 only)
  #=================================================
  test-windows:
    name: Test Build Windows (x64)
    runs-on: windows-latest
    needs: [integration-test-sqlite, integration-test-mysql, integration-test-postgres]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Download Dependencies
        run: go mod tidy
      - name: Install MinGW (CGO toolchain)
        run: choco install mingw --force -y --no-progress
      
      - name: Prepare test environment
        shell: bash
        run: |
          mkdir -p ${{ env.TEST_DIR }}
          cp -r web migrations ${{ env.TEST_DIR }}/
          JWT_KEY=$(openssl rand -hex 32)
          cat > ${{ env.TEST_DIR }}/.env << EOF
          JWT_SECRET_KEY=${JWT_KEY}
          DB_DIALECT=sqlite
          DB_DSN=test_db.sqlite?_foreign_keys=on
          PORT=8080
          BCRYPT_COST=4
          EOF
      
      - name: Build test executable
        env: 
          GOARCH: amd64
          CGO_ENABLED: 1
        run: go build -v -o ${{ env.TEST_DIR }}/${{ env.APP_NAME }}.exe ./cmd/main.go
      
      - name: Run smoke test
        shell: pwsh
        timeout-minutes: 2
        run: |
          cd ${{ env.TEST_DIR }}
          $process = Start-Process -FilePath ".\${{ env.APP_NAME }}.exe" -PassThru -NoNewWindow -RedirectStandardOutput "stdout.log" -RedirectStandardError "stderr.log"
          Write-Host "Application started with PID: $($process.Id)"
          $maxWait = 30; $waited = 0; $serverReady = $false
          while ($waited -lt $maxWait) {
            Write-Host "Checking server... ($waited/$maxWait seconds)"
            Start-Sleep -Seconds 2
            $waited += 2
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8080/login" -TimeoutSec 3 -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "SUCCESS: Server is ready and responding!"
                $serverReady = $true
                break
              }
            } catch {}
          }
          if (-not $serverReady) {
            Write-Host "`n=== STDOUT LOG ==="
            Get-Content "stdout.log" -ErrorAction SilentlyContinue
            Write-Host "`n=== STDERR LOG ==="
            Get-Content "stderr.log" -ErrorAction SilentlyContinue
          }
          Write-Host "Stopping application..."
          if (-not $process.HasExited) { Stop-Process -Id $process.Id -Force }
          if (-not $serverReady) { exit 1 }
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-windows-x64
          path: |
            ${{ env.TEST_DIR }}/stdout.log
            ${{ env.TEST_DIR }}/stderr.log
            ${{ env.TEST_DIR }}/*.sqlite
          retention-days: 7

  #=================================================
  # JOB 6: Test Build di Linux (amd64)
  #=================================================
  test-linux:
    name: Test Build Linux (amd64)
    runs-on: ubuntu-latest
    needs: [integration-test-sqlite, integration-test-mysql, integration-test-postgres]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Download Dependencies
        run: go mod tidy
      - name: Install CGO dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc libgtk-3-dev libayatana-appindicator3-dev xvfb
      
      - name: Prepare test environment
        run: |
          mkdir -p ${{ env.TEST_DIR }}
          cp -r web migrations ${{ env.TEST_DIR }}/
          JWT_KEY=$(openssl rand -hex 32)
          cat > ${{ env.TEST_DIR }}/.env << EOF
          JWT_SECRET_KEY=${JWT_KEY}
          DB_DIALECT=sqlite
          DB_DSN=test_db.sqlite?_foreign_keys=on
          PORT=8080
          BCRYPT_COST=4
          EOF
      
      - name: Build test executable
        env: 
          CGO_ENABLED: 1
        run: go build -v -o ${{ env.TEST_DIR }}/${{ env.APP_NAME }} ./cmd/main.go
      
      - name: Start virtual display
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          sleep 2
      
      - name: Run smoke test
        timeout-minutes: 2
        env: 
          DISPLAY: :99
        run: |
          cd ${{ env.TEST_DIR }}
          ./${{ env.APP_NAME }} > stdout.log 2> stderr.log &
          APP_PID=$!
          echo "Application started with PID: $APP_PID"
          MAX_WAIT=30; WAITED=0; SERVER_READY=false
          while [ $WAITED -lt $MAX_WAIT ]; do
            echo "Checking server... ($WAITED/$MAX_WAIT seconds)"
            sleep 2
            WAITED=$((WAITED + 2))
            if ! kill -0 $APP_PID 2>/dev/null; then
              echo "ERROR: Application process died unexpectedly!"
              cat stdout.log; echo ""; cat stderr.log
              exit 1
            fi
            if curl --fail --silent --show-error --max-time 3 http://localhost:8080/login > /dev/null 2>&1; then
              echo "SUCCESS: Server is ready and responding!"
              SERVER_READY=true
              break
            fi
          done
          if [ "$SERVER_READY" = false ]; then
            echo "ERROR: Server not responding after $MAX_WAIT seconds"
            cat stdout.log; echo ""; cat stderr.log
            kill $APP_PID 2>/dev/null || true
            exit 1
          fi
          kill $APP_PID 2>/dev/null || true
      
      - name: Cleanup virtual display
        if: always()
        run: |
          if [ -n "$XVFB_PID" ]; then
            kill $XVFB_PID 2>/dev/null || true
          fi
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-linux-amd64
          path: |
            ${{ env.TEST_DIR }}/stdout.log
            ${{ env.TEST_DIR }}/stderr.log
            ${{ env.TEST_DIR }}/*.sqlite
          retention-days: 7

  #=================================================
  # JOB 7: Test Build di macOS (amd64)
  #=================================================
  test-macos:
    name: Test Build macOS (amd64)
    runs-on: macos-latest
    needs: [integration-test-sqlite, integration-test-mysql, integration-test-postgres]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with: 
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Download Dependencies
        run: go mod tidy
      
      - name: Prepare test environment
        run: |
          mkdir -p ${{ env.TEST_DIR }}
          cp -r web migrations ${{ env.TEST_DIR }}/
          JWT_KEY=$(openssl rand -hex 32)
          cat > ${{ env.TEST_DIR }}/.env << EOF
          JWT_SECRET_KEY=${JWT_KEY}
          DB_DIALECT=sqlite
          DB_DSN=test_db.sqlite?_foreign_keys=on
          PORT=8080
          BCRYPT_COST=4
          EOF
      
      - name: Build test executable
        env: 
          CGO_ENABLED: 1
        run: go build -v -o ${{ env.TEST_DIR }}/${{ env.APP_NAME }} ./cmd/main.go
      
      - name: Run smoke test
        timeout-minutes: 2
        run: |
          cd ${{ env.TEST_DIR }}
          ./${{ env.APP_NAME }} > stdout.log 2> stderr.log &
          APP_PID=$!
          echo "Application started with PID: $APP_PID"
          MAX_WAIT=30; WAITED=0; SERVER_READY=false
          while [ $WAITED -lt $MAX_WAIT ]; do
            echo "Checking server... ($WAITED/$MAX_WAIT seconds)"
            sleep 2
            WAITED=$((WAITED + 2))
            if ! kill -0 $APP_PID 2>/dev/null; then
              echo "ERROR: Application process died unexpectedly!"
              cat stdout.log; echo ""; cat stderr.log
              exit 1
            fi
            if curl --fail --silent --show-error --max-time 3 http://localhost:8080/login > /dev/null 2>&1; then
              echo "SUCCESS: Server is ready and responding!"
              SERVER_READY=true
              break
            fi
          done
          if [ "$SERVER_READY" = false ]; then
            echo "ERROR: Server not responding after $MAX_WAIT seconds"
            cat stdout.log; echo ""; cat stderr.log
            kill $APP_PID 2>/dev/null || true
            exit 1
          fi
          kill $APP_PID 2>/dev/null || true
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-macos-amd64
          path: |
            ${{ env.TEST_DIR }}/stdout.log
            ${{ env.TEST_DIR }}/stderr.log
            ${{ env.TEST_DIR }}/*.sqlite
          retention-days: 7

  #=================================================
  # JOB SUMMARY: Ringkasan Hasil Build
  #=================================================
  build-summary:
    name: Build Summary Report
    runs-on: ubuntu-latest
    needs: 
      - unit-tests
      - integration-test-sqlite
      - integration-test-mysql
      - integration-test-postgres
      - test-windows
      - test-linux
      - test-macos
    if: always()
    
    steps:
      - name: Generate build summary
        run: |
          echo "## ðŸ“Š Build & Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Go) | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Test (SQLite) | ${{ needs.integration-test-sqlite.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Test (MySQL) | ${{ needs.integration-test-mysql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Test (PostgreSQL) | ${{ needs.integration-test-postgres.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows (x64) Build | ${{ needs.test-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux (amd64) Build | ${{ needs.test-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS (amd64) Build | ${{ needs.test-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          SUCCESS_COUNT=0
          [ "${{ needs.unit-tests.result }}" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.integration-test-sqlite.result }}" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.integration-test-mysql.result }}" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.integration-test-postgres.result }}" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.test-windows.result }}" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.test-linux.result }}" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.test-macos.result }}" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          
          echo "### Results: $SUCCESS_COUNT/7 jobs passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $SUCCESS_COUNT -eq 7 ]; then
            echo "âœ… **All builds and tests completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some jobs failed. Please review the logs.**" >> $GITHUB_STEP_SUMMARY
          fi