name: Test Makefile Build System

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: simdokpol
  GO_VERSION: '1.21'

jobs:
  # --- TEST MAKEFILE SYNTAX & STRUCTURE ---
  test-makefile-syntax:
    name: Test Makefile Syntax & Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test Makefile syntax
        run: |
          echo "ðŸ” Testing Makefile syntax..."
          make -n --dry-run all > /dev/null 2>&1 || { echo "âŒ Makefile syntax error in 'all' target"; exit 1; }
          make -n --dry-run clean > /dev/null 2>&1 || { echo "âŒ Makefile syntax error in 'clean' target"; exit 1; }
          make -n --dry-run deps > /dev/null 2>&1 || { echo "âŒ Makefile syntax error in 'deps' target"; exit 1; }
          echo "âœ… Makefile syntax is valid"

      - name: Test Makefile targets
        run: |
          echo "ðŸ“‹ Available Makefile targets:"
          make list-targets || { echo "âŒ list-targets failed"; exit 1; }
          
          echo "ðŸ” Testing critical targets..."
          make -n --dry-run windows 2>&1 || { echo "âŒ windows target has issues"; exit 1; }
          make -n --dry-run linux 2>&1 || { echo "âŒ linux target has issues"; exit 1; }
          make -n --dry-run clean 2>&1 || { echo "âŒ clean target has issues"; exit 1; }
          echo "âœ… Critical targets are valid"

      - name: Validate Makefile variables
        run: |
          echo "ðŸ” Validating Makefile variables..."
          if ! grep -q "APP_NAME :=" Makefile; then
            echo "âŒ APP_NAME variable not found"
            exit 1
          fi
          if ! grep -q "BUILD_DIR :=" Makefile; then
            echo "âŒ BUILD_DIR variable not found"
            exit 1
          fi
          if ! grep -q "VERSION_FULL :=" Makefile; then
            echo "âŒ VERSION_FULL variable not found"
            exit 1
          fi
          echo "âœ… All required variables are defined"

  # --- TEST DEPENDENCY INSTALLATION ---
  test-dependencies-linux:
    name: Test Linux Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Test Linux dependency commands
        run: |
          echo "ðŸ” Testing dependency installation on Linux..."
          make -n --dry-run install-deps 2>&1 || { echo "âŒ install-deps has syntax errors"; exit 1; }
          echo "âœ… Linux dependency installation test passed"

      - name: Test Go dependencies
        run: |
          echo "ðŸ” Testing Go module dependencies..."
          make -n --dry-run deps 2>&1 || { echo "âŒ deps target has issues"; exit 1; }
          echo "âœ… Go dependencies test passed"

  test-dependencies-macos:
    name: Test macOS Dependencies
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Test macOS dependency commands
        shell: bash
        run: |
          echo "ðŸ” Testing macOS dependency commands..."
          make -n --dry-run check-macos-deps 2>&1 || echo "âš ï¸  check-macos-deps has warnings (expected)"
          echo "âœ… macOS dependency test completed"

  test-dependencies-windows:
    name: Test Windows Dependencies
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Test Windows environment
        shell: bash
        run: |
          echo "ðŸ” Testing Windows environment..."
          which make || echo "âš ï¸  Make not found (expected on Windows)"
          which go || { echo "âŒ Go not found"; exit 1; }
          echo "âœ… Windows environment test completed"

  # --- TEST BUILD COMMANDS (DRY RUN) ---
  test-build-commands:
    name: Test Build Commands (Dry Run)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make git

      - name: Test Windows build commands
        run: |
          echo "ðŸ” Testing Windows build commands..."
          make -n --dry-run windows 2>&1 || { echo "âŒ windows target failed"; exit 1; }
          make -n --dry-run windows-arm64 2>&1 || { echo "âŒ windows-arm64 target failed"; exit 1; }
          echo "âœ… Windows build commands are valid"

      - name: Test Linux build commands
        run: |
          echo "ðŸ” Testing Linux build commands..."
          make -n --dry-run linux 2>&1 || { echo "âŒ linux target failed"; exit 1; }
          echo "âœ… Linux build commands are valid"

      - name: Test macOS build commands
        run: |
          echo "ðŸ” Testing macOS build commands..."
          make -n --dry-run macos 2>&1 || { echo "âŒ macos target failed"; exit 1; }
          echo "âœ… macOS build commands are valid"

      - name: Test installer commands
        run: |
          echo "ðŸ” Testing installer commands..."
          make -n --dry-run installer-windows 2>&1 || echo "âš ï¸  installer-windows has warnings (expected)"
          make -n --dry-run installer-linux 2>&1 || echo "âš ï¸  installer-linux has warnings (expected)"
          make -n --dry-run installer-macos 2>&1 || echo "âš ï¸  installer-macos has warnings (expected)"
          echo "âœ… Installer commands test completed"

  # --- ACTUAL BUILD TEST (SMALL SCALE) ---
  test-actual-build:
    name: Test Actual Build (Small Scale)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make git gcc || { echo "âŒ Failed to install dependencies"; exit 1; }

      - name: Test Go modules
        run: |
          echo "ðŸ” Testing Go modules..."
          if [ -f "go.mod" ]; then
            go mod download || { echo "âŒ Failed to download Go modules"; exit 1; }
            go mod verify || { echo "âŒ Failed to verify Go modules"; exit 1; }
            echo "âœ… Go modules are valid"
          else
            echo "âš ï¸  go.mod not found, skipping module test"
          fi

      - name: Test basic compilation
        run: |
          echo "ðŸ” Testing basic Go compilation..."
          if [ -f "cmd/main.go" ]; then
            go build -o /tmp/test-build ./cmd/main.go 2>&1 || echo "âš ï¸  Main compilation test failed (may be expected due to dependencies)"
            
            if [ -f "/tmp/test-build" ]; then
              echo "âœ… Basic compilation test passed"
              rm /tmp/test-build
            else
              echo "âš ï¸  Binary not created, but continuing..."
            fi
          else
            echo "âš ï¸  cmd/main.go not found, skipping compilation test"
          fi

      - name: Test Makefile clean target
        run: |
          echo "ðŸ” Testing clean target..."
          make clean || { echo "âŒ Clean target failed"; exit 1; }
          if [ ! -d "build" ] && [ ! -d "release" ]; then
            echo "âœ… Clean target works correctly"
          else
            echo "âš ï¸  Build directories still exist after clean"
          fi

      - name: Test version generation
        run: |
          echo "ðŸ” Testing version generation..."
          make -n --dry-run changelog 2>&1 || { echo "âŒ changelog target failed"; exit 1; }
          echo "âœ… Version generation commands are valid"

  # --- CROSS-PLATFORM COMPATIBILITY TEST ---
  test-cross-platform:
    name: Test Cross-Platform - ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [windows, linux, macos]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Test cross-compilation for ${{ matrix.target }}
        run: |
          echo "ðŸ” Testing ${{ matrix.target }} cross-compilation..."
          make -n --dry-run ${{ matrix.target }} 2>&1 || { echo "âŒ ${{ matrix.target }} target failed"; exit 1; }
          echo "âœ… ${{ matrix.target }} cross-compilation test passed"

  # --- INTEGRATION TEST WITH MAKE MENU ---
  test-make-menu:
    name: Test Make Menu System
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Test menu display
        run: |
          echo "ðŸ” Testing menu display..."
          make -n --dry-run package 2>&1 || { echo "âŒ package target failed"; exit 1; }
          echo "âœ… Menu display test passed"

      - name: Test individual menu options
        run: |
          echo "ðŸ” Testing individual menu options..."
          make -n --dry-run release 2>&1 || { echo "âŒ release target failed"; exit 1; }
          make -n --dry-run list-targets 2>&1 || { echo "âŒ list-targets failed"; exit 1; }
          echo "âœ… Menu options test passed"

      - name: Test help command
        run: |
          echo "ðŸ” Testing help command..."
          make help || { echo "âŒ help target failed"; exit 1; }
          echo "âœ… Help command test passed"

  # --- VALIDATE BUILD STRUCTURE ---
  test-build-structure:
    name: Test Build Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate project structure
        run: |
          echo "ðŸ” Validating project structure..."
          
          # Check for essential files
          [ -f "Makefile" ] || { echo "âŒ Makefile not found"; exit 1; }
          [ -f "go.mod" ] || echo "âš ï¸  go.mod not found (may be expected)"
          [ -d "cmd" ] || echo "âš ï¸  cmd directory not found"
          
          echo "âœ… Project structure validation completed"

      - name: Test Makefile phony targets
        run: |
          echo "ðŸ” Testing .PHONY declarations..."
          grep -q "^\.PHONY:" Makefile || { echo "âŒ .PHONY declaration not found"; exit 1; }
          echo "âœ… .PHONY targets are declared"

  # --- FINAL REPORT ---
  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: 
      - test-makefile-syntax
      - test-dependencies-linux
      - test-dependencies-macos
      - test-dependencies-windows
      - test-build-commands
      - test-actual-build
      - test-cross-platform
      - test-make-menu
      - test-build-structure
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate test report
        run: |
          echo "ðŸ“Š ==========================================="
          echo "ðŸ“Š MAKEFILE TEST REPORT - $(date)"
          echo "ðŸ“Š ==========================================="
          
          # Check job results
          if [ "${{ needs.test-makefile-syntax.result }}" == "success" ] && \
             [ "${{ needs.test-dependencies-linux.result }}" == "success" ] && \
             [ "${{ needs.test-build-commands.result }}" == "success" ] && \
             [ "${{ needs.test-actual-build.result }}" == "success" ] && \
             [ "${{ needs.test-cross-platform.result }}" == "success" ] && \
             [ "${{ needs.test-make-menu.result }}" == "success" ] && \
             [ "${{ needs.test-build-structure.result }}" == "success" ]; then
            echo "ðŸ“Š âœ… All critical Makefile tests passed!"
          else
            echo "ðŸ“Š âš ï¸  Some tests failed or were skipped"
          fi
          
          echo "ðŸ“Š "
          echo "ðŸ“Š Test Summary:"
          echo "ðŸ“Š - Makefile syntax: ${{ needs.test-makefile-syntax.result }}"
          echo "ðŸ“Š - Linux dependencies: ${{ needs.test-dependencies-linux.result }}"
          echo "ðŸ“Š - macOS dependencies: ${{ needs.test-dependencies-macos.result }}"
          echo "ðŸ“Š - Windows dependencies: ${{ needs.test-dependencies-windows.result }}"
          echo "ðŸ“Š - Build commands: ${{ needs.test-build-commands.result }}"
          echo "ðŸ“Š - Actual build: ${{ needs.test-actual-build.result }}"
          echo "ðŸ“Š - Cross-platform: ${{ needs.test-cross-platform.result }}"
          echo "ðŸ“Š - Menu system: ${{ needs.test-make-menu.result }}"
          echo "ðŸ“Š - Build structure: ${{ needs.test-build-structure.result }}"
          echo "ðŸ“Š "
          echo "ðŸ“Š ==========================================="

      - name: Create summary
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Category | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Makefile Syntax | ${{ needs.test-makefile-syntax.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux Dependencies | ${{ needs.test-dependencies-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Dependencies | ${{ needs.test-dependencies-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows Dependencies | ${{ needs.test-dependencies-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Commands | ${{ needs.test-build-commands.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actual Build | ${{ needs.test-actual-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cross-Platform | ${{ needs.test-cross-platform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Menu System | ${{ needs.test-make-menu.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Structure | ${{ needs.test-build-structure.result }} |" >> $GITHUB_STEP_SUMMARY