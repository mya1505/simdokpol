name: Test Makefile Build System

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: simdokpol
  GO_VERSION: '1.21'

jobs:
  test-makefile-syntax:
    name: Test Makefile Syntax & Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Makefile syntax
        run: |
          echo "ğŸ” Testing Makefile syntax..."
          make -n --dry-run all
          make -n --dry-run clean
          make -n --dry-run deps
          echo "âœ… Makefile syntax is valid"

      - name: Test Makefile targets
        run: |
          echo "ğŸ“‹ Available Makefile targets:"
          make list-targets
          echo "âœ… All targets are valid"

  test-dependencies:
    name: Test Dependency Installation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Test dependency commands
        run: |
          echo "ğŸ” Testing dependency commands..."
          make -n --dry-run install-deps
          make -n --dry-run check-deps
          echo "âœ… Dependency commands are valid"

  test-build-commands:
    name: Test Build Commands
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Test build commands
        run: |
          echo "ğŸ” Testing build commands..."
          make -n --dry-run windows
          make -n --dry-run linux
          make -n --dry-run macos
          make -n --dry-run installer-windows
          echo "âœ… All build commands are valid"

  test-actual-build:
    name: Test Actual Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install basic deps
        run: sudo apt-get update && sudo apt-get install -y make git

      - name: Test Go modules
        run: |
          echo "ğŸ” Testing Go modules..."
          go mod download
          go mod verify
          echo "âœ… Go modules are valid"

      - name: Test basic compilation
        run: |
          echo "ğŸ” Testing basic compilation..."
          make deps
          # Test minimal build functionality
          mkdir -p test-build
          echo 'package main\nimport "fmt"\nfunc main() { fmt.Println("test") }' > test-build/test.go
          cd test-build && go build test.go && ./test
          echo "âœ… Basic compilation test passed"

  generate-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [test-makefile-syntax, test-dependencies, test-build-commands, test-actual-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate report
        run: |
          echo "ğŸ“Š ==========================================="
          echo "ğŸ“Š MAKEFILE TEST REPORT - $(date)"
          echo "ğŸ“Š ==========================================="
          echo "ğŸ“Š âœ… All Makefile tests completed successfully!"
          echo "ğŸ“Š "
          echo "ğŸ“Š Test Summary:"
          echo "ğŸ“Š - âœ… Makefile syntax and structure"
          echo "ğŸ“Š - âœ… Dependency installation commands"
          echo "ğŸ“Š - âœ… Build commands validation"
          echo "ğŸ“Š - âœ… Actual build verification"
          echo "ğŸ“Š "
          echo "ğŸ“Š Build System: v9.0 - Installer Edition"
          echo "ğŸ“Š ==========================================="