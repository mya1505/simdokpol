; SIMDOKPOL Installer Template
; Generated by Makefile

!define APP_NAME "@APP_NAME@"
!define VERSION "@VERSION@"
!define PUBLISHER "@PUBLISHER@"
!define WEB_SITE "@WEB_SITE@"
!define INSTALLER_NAME "@INSTALLER_NAME@"
!define EXE_NAME "simdokpol.exe"

; --- Tampilan & Gambar ---
!define MUI_ICON "@ICON_PATH@"
!define MUI_UNICON "@ICON_PATH@"
@BANNER_DIRECTIVE@
@HEADER_DIRECTIVE@

; --- Konfigurasi Utama ---
Name "${APP_NAME} ${VERSION}"
OutFile "${INSTALLER_NAME}"
InstallDir "$PROGRAMFILES64\${APP_NAME}"
InstallDirRegKey HKLM "Software\${APP_NAME}" "Install_Dir"
RequestExecutionLevel admin
SetCompressor lzma

!include "MUI2.nsh"
!define MUI_ABORTWARNING

; --- Halaman Installer ---
!insertmacro MUI_PAGE_WELCOME
@LICENSE_DIRECTIVE@
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!define MUI_FINISHPAGE_RUN "$INSTDIR\${EXE_NAME}"
!insertmacro MUI_PAGE_FINISH

; --- Halaman Uninstaller ---
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

!insertmacro MUI_LANGUAGE "Indonesian"

; --- SECTION INSTALL ---
Section "Main Application" SecMain
  SetOutPath "$INSTDIR"
  
  ; Copy Binary Utama
  File "..\..\build\windows\${EXE_NAME}"
  
  ; Copy File Pendukung (Cek keberadaan file via script eksternal jika perlu)
  File /nonfatal "..\..\README.md"
  File /nonfatal "..\..\LICENSE"
  
  ; Copy Asset Web & Migrations
  SetOutPath "$INSTDIR\web"
  File /r "..\..\web\*"
  
  SetOutPath "$INSTDIR\migrations"
  File /r "..\..\migrations\*"

  ; Registry & Uninstaller
  WriteRegStr HKLM "Software\${APP_NAME}" "Install_Dir" "$INSTDIR"
  WriteUninstaller "$INSTDIR\uninstall.exe"

  ; Control Panel Entry
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APP_NAME}" "DisplayName" "${APP_NAME}"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APP_NAME}" "DisplayIcon" "$INSTDIR\${EXE_NAME}"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APP_NAME}" "UninstallString" "$INSTDIR\uninstall.exe"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APP_NAME}" "DisplayVersion" "${VERSION}"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APP_NAME}" "Publisher" "${PUBLISHER}"
SectionEnd

; --- SECTION SHORTCUTS ---
Section "Desktop & Start Menu Shortcuts" SecShortcuts
  CreateDirectory "$SMPROGRAMS\${APP_NAME}"
  CreateShortcut "$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk" "$INSTDIR\${EXE_NAME}" "" "$INSTDIR\web\static\img\icon.ico" 0
  CreateShortcut "$SMPROGRAMS\${APP_NAME}\Uninstall.lnk" "$INSTDIR\uninstall.exe"
  CreateShortcut "$DESKTOP\${APP_NAME}.lnk" "$INSTDIR\${EXE_NAME}" "" "$INSTDIR\web\static\img\icon.ico" 0
SectionEnd

; --- SECTION UNINSTALL ---
Section "Uninstall"
  Delete "$INSTDIR\${EXE_NAME}"
  Delete "$INSTDIR\uninstall.exe"
  Delete "$INSTDIR\README.md"
  Delete "$INSTDIR\LICENSE"
  
  RMDir /r "$INSTDIR\web"
  RMDir /r "$INSTDIR\migrations"
  RMDir /r "$INSTDIR\logs"
  RMDir "$INSTDIR"

  Delete "$SMPROGRAMS\${APP_NAME}\${APP_NAME}.lnk"
  Delete "$SMPROGRAMS\${APP_NAME}\Uninstall.lnk"
  RMDir "$SMPROGRAMS\${APP_NAME}"
  Delete "$DESKTOP\${APP_NAME}.lnk"

  DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APP_NAME}"
  DeleteRegKey HKLM "Software\${APP_NAME}"
SectionEnd